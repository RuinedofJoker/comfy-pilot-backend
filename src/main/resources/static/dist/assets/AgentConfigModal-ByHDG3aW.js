import{A as Z,a as m,X as oe,Y as ne,Z as ae,x as $,$ as F,s as J,j,a0 as X,M as W,a1 as se,a2 as le,a3 as re,d as Q,u as ie,n as ue,k as v,o as l,e,l as U,y as ee,m as b,_ as te,a4 as de,a5 as ce,a6 as ve,D as fe,b as L,c as B,w as P,F as H,z as R,K as pe,h as G,i as q,g as K,E as me,J as ge,t as S}from"./index-DUI3biLs.js";import{l as he,b as Ce}from"./auth-DHo3H-uo.js";import{s as ye}from"./function-call-1j34QfgJ.js";import{b as z}from"./agent-ChawvV1-.js";import{a as Y}from"./model-JByLflBC.js";const _e=Z("auth",()=>{const g=m(oe()||""),A=m(ne()||""),i=m(ae()),h=m(!1),C=$(()=>!!g.value),V=$(()=>F().isAdmin);async function T(a){h.value=!0;try{const u=await he(a);g.value=u.accessToken,A.value=u.refreshToken,J(u.accessToken),j(u.refreshToken),i.value=u.user,X(u.user);const E=W(),x=F();E.setUserInfo(u.user),await x.fetchRolesAndPermissions()}finally{h.value=!1}}async function c(){try{await Ce()}catch(a){console.error("登出失败:",a)}finally{k()}}function k(){g.value="",A.value="",i.value=null,se(),le(),re();const a=W(),u=F();a.clearUserData(),u.clearPermissionData()}function y(a){i.value&&(i.value={...i.value,...a},X(i.value))}function _(a,u){g.value=a,J(a),u&&(A.value=u,j(u))}return{token:g,refreshToken:A,userInfo:i,isLoading:h,isAuthenticated:C,isAdmin:V,login:T,logout:c,clearAuth:k,updateUserInfo:y,updateToken:_}}),Ae={class:"g-top-nav"},ke={class:"m-nav-right"},we={class:"f-user-avatar"},Se={key:0,class:"f-user-dropdown"},be={class:"f-dropdown-header"},Ve={class:"f-dropdown-user-name"},Te={class:"f-dropdown-user-email"},xe=Q({__name:"TopNavBar",emits:["open-mcp-config","open-agent-config"],setup(g,{emit:A}){const i=A,h=ie(),C=ue(),V=W(),T=_e(),c=m(!1),k=$(()=>C.path.startsWith("/comfy/workflows/")),y=$(()=>V.username||"用户"),_=$(()=>V.email||"user@example.com"),a=$(()=>(V.username||"U").charAt(0).toUpperCase());function u(){c.value=!c.value}function E(){h.push("/services")}function x(){c.value=!1,h.push("/workflows")}function s(){i("open-mcp-config")}function N(){i("open-agent-config")}function I(){c.value=!1,h.push("/profile")}async function M(){c.value=!1;try{await ye({title:"确认退出",message:"确定要退出登录吗？",confirmButtonText:"退出",cancelButtonText:"取消"}),await T.logout(),h.push("/login")}catch{}}return(D,d)=>(l(),v("div",Ae,[e("div",{class:"m-nav-left"},[e("div",{class:"f-logo",onClick:E},[...d[0]||(d[0]=[e("div",{class:"f-logo-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"})])],-1),e("span",null,"ComfyUI Pilot",-1)])])]),e("div",ke,[e("button",{class:"f-nav-btn",onClick:x},[...d[1]||(d[1]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"})],-1),e("span",null,"我的工作流",-1)])]),k.value?(l(),v("button",{key:0,class:"f-nav-btn",onClick:s},[...d[2]||(d[2]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"}),e("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})],-1),e("span",null,"MCP 工具",-1)])])):U("",!0),e("button",{class:"f-nav-btn",onClick:N},[...d[3]||(d[3]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"}),e("path",{d:"M12 6v6l4 2"})],-1),e("span",null,"Agent 配置",-1)])]),e("div",{class:ee(["f-user-menu",{active:c.value}])},[e("div",{class:"f-user-info",onClick:u},[e("div",we,b(a.value),1),e("span",null,b(y.value),1),d[4]||(d[4]=e("span",{class:"f-dropdown-arrow"},"▼",-1))]),c.value?(l(),v("div",Se,[e("div",be,[e("div",Ve,b(y.value),1),e("div",Te,b(_.value),1)]),e("div",{class:"f-dropdown-menu"},[e("div",{class:"f-dropdown-item",onClick:I},[...d[5]||(d[5]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e("circle",{cx:"12",cy:"7",r:"4"})],-1),e("span",null,"个人信息",-1)])]),e("div",{class:"f-dropdown-item",onClick:x},[...d[6]||(d[6]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"})],-1),e("span",null,"我的工作流",-1)])]),d[8]||(d[8]=e("div",{class:"f-dropdown-divider"},null,-1)),e("div",{class:"f-dropdown-item danger",onClick:M},[...d[7]||(d[7]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e("polyline",{points:"16 17 21 12 16 7"}),e("line",{x1:"21",y1:"12",x2:"9",y2:"12"})],-1),e("span",null,"退出登录",-1)])])])])):U("",!0)],2)])]))}}),lt=te(xe,[["__scopeId","data-v-672cb6db"]]),Ue=Z("userAgentConfig",()=>{const g=m([]),A=m([]),i=m(""),h=m(!1),C=$(()=>g.value.filter(s=>s.agentConfig&&s.agentConfig.trim()!=="")),V=$(()=>g.value.find(s=>s.agentCode===i.value)),T=$(()=>A.value.find(s=>s.agentCode===i.value));async function c(){h.value=!0;try{g.value=await z.getUserAgentConfigs(),i.value||u()}finally{h.value=!1}}async function k(){try{A.value=await z.getEnabledAgents()}catch(s){console.error("加载运行时 Agent 列表失败:",s)}}async function y(s){await z.updateUserAgentConfig(s),await c()}function _(s){i.value=s,de(s)}function a(){const s=C.value;if(s.length===0)return;const I=(s.findIndex(D=>D.agentCode===i.value)+1)%s.length,M=s[I];M&&_(M.agentCode)}function u(){const s=ce();if(s&&C.value.some(M=>M.agentCode===s)){i.value=s;return}const N=C.value[0];N&&_(N.agentCode)}async function E(){await Promise.all([c(),k()])}function x(){g.value=[],A.value=[],i.value="",ve()}return{userAgentConfigs:g,runtimeAgents:A,selectedAgentCode:i,isLoading:h,configuredAgents:C,currentAgentConfig:V,currentAgent:T,loadUserAgentConfigs:c,loadRuntimeAgents:k,updateUserAgentConfig:y,selectAgent:_,selectNextAgent:a,autoSelectFirstConfiguredAgent:u,initData:E,clearData:x}}),$e={class:"m-agent-config-modal"},Me={class:"f-modal-body"},Ee={class:"f-agent-list"},Ne=["onClick"],Ie={class:"f-agent-card-header"},Be={class:"f-agent-name"},De={key:0,class:"f-config-badge"},ze={key:0,class:"f-agent-description"},Oe={class:"f-config-form"},Le={key:0,class:"f-empty-state"},Pe={key:1,class:"f-config-content"},Fe={class:"f-config-header"},He={class:"f-config-title"},Re={key:0,class:"f-config-description"},qe={key:0,class:"f-form-section"},We={class:"f-label"},Je={key:0,class:"f-required"},je={key:5,class:"f-select-wrapper"},Xe=["onUpdate:modelValue","onFocus"],Ge=["value"],Ke=["onClick"],Ye={key:1,class:"f-no-config"},Ze={class:"f-form-actions"},Qe=["disabled"],et=Q({__name:"AgentConfigModal",props:{visible:{type:Boolean}},emits:["update:visible"],setup(g,{emit:A}){const i=g,h=A,C=Ue(),V=m(!1),T=m(!1),c=m(""),k=m(null),y=m([]),_=m({}),a=m({});function u(t){return C.configuredAgents.some(n=>n.agentCode===t)}function E(t){return!t||!_.value[t]?[]:_.value[t].map(n=>({text:n.modelDisplayName,value:n.modelIdentifier}))}function x(t,n){const r=n==="INT"?t.intStartScope:t.floatStartScope,p=n==="INT"?t.intEndScope:t.floatEndScope;return r!==void 0&&p!==void 0?`请输入${r}到${p}之间的数值`:r!==void 0?`请输入大于等于${r}的数值`:p!==void 0?`请输入小于等于${p}的数值`:`请输入${t.description||t.name}`}async function s(t){c.value=t;try{const n=await z.getAgentByCode(t);k.value=n,y.value=n.agentConfigDefinitions||[],_.value={},a.value={},y.value.forEach(p=>{p.type==="BOOLEAN"?a.value[p.name]=!1:p.type==="MODEL"?a.value[p.name]=null:a.value[p.name]=""});const r=C.userAgentConfigs.find(p=>p.agentCode===t);if(r&&r.agentConfig){const p=y.value.filter(w=>w.type==="MODEL"&&w.modelCallingType).map(async w=>{try{const o=await Y.listEnabledModels(w.modelCallingType);_.value[w.modelCallingType]=o}catch(o){console.error(`加载模型列表失败 (${w.modelCallingType}):`,o)}});await Promise.all(p);const O=JSON.parse(r.agentConfig);Object.keys(O).forEach(w=>{w in a.value&&(a.value[w]=O[w])})}}catch(n){console.error("获取 Agent 详情失败:",n),S.error("获取 Agent 详情失败")}}async function N(t){if(!t.modelCallingType){S.error("该配置未指定模型调用方式");return}if(!_.value[t.modelCallingType])try{const n=await Y.listEnabledModels(t.modelCallingType);_.value[t.modelCallingType]=n}catch(n){console.error("获取模型列表失败:",n),S.error("获取模型列表失败")}}function I(){if(!c.value)return S.error("请选择 Agent"),!1;for(const t of y.value){const n=a.value[t.name];if(t.userOverride&&t.require&&(n===""||n===null||n===void 0))return S.error(`请填写${t.description||t.name}`),!1;if(t.type==="INT"&&n!==""&&n!==null&&n!==void 0){const r=Number(n);if(t.intStartScope!==void 0&&r<t.intStartScope)return S.error(`${t.description||t.name}不能小于${t.intStartScope}`),!1;if(t.intEndScope!==void 0&&r>t.intEndScope)return S.error(`${t.description||t.name}不能大于${t.intEndScope}`),!1}if(t.type==="FLOAT"&&n!==""&&n!==null&&n!==void 0){const r=Number(n);if(t.floatStartScope!==void 0&&r<t.floatStartScope)return S.error(`${t.description||t.name}不能小于${t.floatStartScope}`),!1;if(t.floatEndScope!==void 0&&r>t.floatEndScope)return S.error(`${t.description||t.name}不能大于${t.floatEndScope}`),!1}}return!0}async function M(){if(I()){T.value=!0;try{const t={};y.value.forEach(n=>{const r=a.value[n.name];r!==""&&r!==null&&r!==void 0&&(t[n.name]=r)}),await z.updateUserAgentConfig({agentCode:c.value,agentConfig:JSON.stringify(t)}),S.success("保存成功"),await C.loadUserAgentConfigs()}catch(t){console.error("保存失败:",t),S.error("保存失败")}finally{T.value=!1}}}async function D(){V.value=!0;try{await C.initData()}finally{V.value=!1}}function d(){h("update:visible",!1)}return fe(()=>i.visible,t=>{t&&D()}),(t,n)=>{const r=L("van-field"),p=L("van-radio"),O=L("van-radio-group"),w=L("van-popup");return l(),B(w,{show:g.visible,position:"center",style:{width:"90%",maxWidth:"800px",height:"80vh"},round:"",closeable:"",onClose:d,"onUpdate:show":n[0]||(n[0]=o=>h("update:visible",o))},{default:P(()=>[e("div",$e,[n[6]||(n[6]=e("h3",{class:"f-modal-title"},"Agent 配置管理",-1)),e("div",Me,[e("div",Ee,[(l(!0),v(H,null,R(pe(C).runtimeAgents,o=>(l(),v("div",{key:o.agentCode,class:ee(["f-agent-card",{active:c.value===o.agentCode}]),onClick:f=>s(o.agentCode)},[e("div",Ie,[e("h4",Be,b(o.agentName),1),u(o.agentCode)?(l(),v("span",De,"已配置")):U("",!0)]),o.description?(l(),v("p",ze,b(o.description),1)):U("",!0)],10,Ne))),128))]),e("div",Oe,[c.value?k.value?(l(),v("div",Pe,[e("div",Fe,[e("h4",He,b(k.value.agentName)+" 配置",1),k.value.description?(l(),v("p",Re,b(k.value.description),1)):U("",!0)]),y.value.length>0?(l(),v("div",qe,[(l(!0),v(H,null,R(y.value,o=>G((l(),v("div",{key:o.name,class:"f-form-item"},[e("label",We,[q(b(o.description||o.name)+" ",1),o.require?(l(),v("span",Je,"*")):U("",!0)]),o.type==="STRING"?(l(),B(r,{key:0,modelValue:a.value[o.name],"onUpdate:modelValue":f=>a.value[o.name]=f,placeholder:`请输入${o.description||o.name}`,border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):o.type==="TEXT"?(l(),B(r,{key:1,modelValue:a.value[o.name],"onUpdate:modelValue":f=>a.value[o.name]=f,type:"textarea",placeholder:`请输入${o.description||o.name}`,border:!1,class:"f-input",rows:"3"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):o.type==="INT"?(l(),B(r,{key:2,modelValue:a.value[o.name],"onUpdate:modelValue":f=>a.value[o.name]=f,modelModifiers:{number:!0},type:"number",placeholder:x(o,"INT"),border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):o.type==="FLOAT"?(l(),B(r,{key:3,modelValue:a.value[o.name],"onUpdate:modelValue":f=>a.value[o.name]=f,modelModifiers:{number:!0},type:"number",step:"0.01",placeholder:x(o,"FLOAT"),border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):o.type==="BOOLEAN"?(l(),B(O,{key:4,modelValue:a.value[o.name],"onUpdate:modelValue":f=>a.value[o.name]=f,direction:"horizontal"},{default:P(()=>[K(p,{name:!0},{default:P(()=>[...n[2]||(n[2]=[q("是",-1)])]),_:1}),K(p,{name:!1},{default:P(()=>[...n[3]||(n[3]=[q("否",-1)])]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue"])):o.type==="MODEL"?(l(),v("div",je,[G(e("select",{"onUpdate:modelValue":f=>a.value[o.name]=f,class:"f-select",onFocus:f=>N(o)},[n[4]||(n[4]=e("option",{value:null,disabled:""},"请选择Model",-1)),(l(!0),v(H,null,R(E(o.modelCallingType),f=>(l(),v("option",{key:f.value,value:f.value},b(f.text),9,Ge))),128))],40,Xe),[[me,a.value[o.name]]]),!o.require&&a.value[o.name]!==null&&a.value[o.name]!==""?(l(),v("span",{key:0,class:"f-select-clear",onClick:f=>a.value[o.name]=null}," × ",8,Ke)):U("",!0)])):U("",!0)])),[[ge,o.userOverride]])),128))])):(l(),v("div",Ye,[...n[5]||(n[5]=[e("p",null,"该 Agent 无需额外配置",-1)])])),e("div",Ze,[e("button",{class:"f-btn f-btn-primary",disabled:T.value,onClick:M},b(T.value?"保存中...":"保存配置"),9,Qe)])])):U("",!0):(l(),v("div",Le,[...n[1]||(n[1]=[e("svg",{class:"f-icon-large",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1),e("p",null,"请选择左侧的 Agent 进行配置",-1)])]))])])])]),_:1},8,["show"])}}}),rt=te(et,[["__scopeId","data-v-ee79fd30"]]);export{rt as A,lt as T,Ue as a,_e as u};
