import{A as ee,a as m,a2 as te,a3 as ne,a4 as ae,x as T,a5 as F,s as K,l as X,a6 as Q,M as q,a7 as se,a8 as le,a9 as re,d as j,b as D,c as N,o as i,w as L,e,m as w,_ as G,u as ie,n as ue,k as v,h as J,f as x,y as oe,aa as de,ab as ce,ac as ve,D as fe,F as H,z as R,K as pe,i as Y,j as W,E as me,J as ge,t as V}from"./index-Bjatt9vk.js";import{l as he,b as Ce}from"./auth-CZZNEzhi.js";import{b as z}from"./agent-CvQiyz7E.js";import{a as Z}from"./model-DI2kR3Im.js";const ye=ee("auth",()=>{const g=m(te()||""),y=m(ne()||""),u=m(ae()),f=m(!1),C=T(()=>!!g.value),b=T(()=>F().isAdmin);async function S(a){f.value=!0;try{const d=await he(a);g.value=d.accessToken,y.value=d.refreshToken,K(d.accessToken),X(d.refreshToken),u.value=d.user,Q(d.user);const U=q(),$=F();U.setUserInfo(d.user),await $.fetchRolesAndPermissions()}finally{f.value=!1}}async function l(){try{await Ce()}catch(a){console.error("登出失败:",a)}finally{c()}}function c(){g.value="",y.value="",u.value=null,se(),le(),re();const a=q(),d=F();a.clearUserData(),d.clearPermissionData()}function _(a){u.value&&(u.value={...u.value,...a},Q(u.value))}function A(a,d){g.value=a,K(a),d&&(y.value=d,X(d))}return{token:g,refreshToken:y,userInfo:u,isLoading:f,isAuthenticated:C,isAdmin:b,login:S,logout:l,clearAuth:c,updateUserInfo:_,updateToken:A}}),_e={class:"m-logout-confirm-modal"},Ae={class:"f-modal-footer"},be=["disabled"],ke=j({__name:"LogoutConfirmModal",props:{visible:{type:Boolean}},emits:["update:visible","confirm"],setup(g,{emit:y}){const u=y,f=m(!1);function C(){u("confirm")}function b(){u("update:visible",!1)}return(S,l)=>{const c=D("van-popup");return i(),N(c,{show:g.visible,position:"center",style:{width:"90%",maxWidth:"420px"},round:"",closeable:"",onClose:b,"onUpdate:show":l[0]||(l[0]=_=>u("update:visible",_))},{default:L(()=>[e("div",_e,[l[1]||(l[1]=e("h3",{class:"f-modal-title"},"确认退出",-1)),l[2]||(l[2]=e("div",{class:"f-modal-body"},[e("p",{class:"f-message"}," 确定要退出登录吗？ ")],-1)),e("div",Ae,[e("button",{class:"f-btn",onClick:b},"取消"),e("button",{class:"f-btn f-btn-danger",onClick:C,disabled:f.value},w(f.value?"退出中...":"退出"),9,be)])])]),_:1},8,["show"])}}}),we=G(ke,[["__scopeId","data-v-ab5427bf"]]),Se={class:"g-top-nav"},Ve={class:"m-nav-right"},xe={class:"f-user-avatar"},Te={key:0,class:"f-user-dropdown"},$e={class:"f-dropdown-header"},Me={class:"f-dropdown-user-name"},Ue={class:"f-dropdown-user-email"},Ee=j({__name:"TopNavBar",emits:["open-mcp-config","open-agent-config"],setup(g,{emit:y}){const u=y,f=ie(),C=ue(),b=q(),S=ye(),l=m(!1),c=m(!1),_=T(()=>C.path.startsWith("/comfy/workflows/")),A=T(()=>b.username||"用户"),a=T(()=>b.email||"user@example.com"),d=T(()=>(b.username||"U").charAt(0).toUpperCase());function U(){l.value=!l.value}function $(){f.push("/services")}function s(){l.value=!1,f.push("/workflows")}function E(){u("open-mcp-config")}function I(){u("open-agent-config")}function M(){l.value=!1,f.push("/profile")}function B(){l.value=!1,c.value=!0}async function P(){try{await S.logout(),c.value=!1,f.push("/login")}catch(t){console.error("退出登录失败:",t),c.value=!1}}return(t,o)=>(i(),v("div",Se,[e("div",{class:"m-nav-left"},[e("div",{class:"f-logo",onClick:$},[...o[1]||(o[1]=[e("div",{class:"f-logo-icon"},[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"})])],-1),e("span",null,"ComfyUI Pilot",-1)])])]),e("div",Ve,[e("button",{class:"f-nav-btn",onClick:s},[...o[2]||(o[2]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"})],-1),e("span",null,"我的工作流",-1)])]),_.value?(i(),v("button",{key:0,class:"f-nav-btn",onClick:E},[...o[3]||(o[3]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"}),e("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})],-1),e("span",null,"MCP 工具",-1)])])):x("",!0),e("button",{class:"f-nav-btn",onClick:I},[...o[4]||(o[4]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"}),e("path",{d:"M12 6v6l4 2"})],-1),e("span",null,"Agent 配置",-1)])]),e("div",{class:oe(["f-user-menu",{active:l.value}])},[e("div",{class:"f-user-info",onClick:U},[e("div",xe,w(d.value),1),e("span",null,w(A.value),1),o[5]||(o[5]=e("span",{class:"f-dropdown-arrow"},"▼",-1))]),l.value?(i(),v("div",Te,[e("div",$e,[e("div",Me,w(A.value),1),e("div",Ue,w(a.value),1)]),e("div",{class:"f-dropdown-menu"},[e("div",{class:"f-dropdown-item",onClick:M},[...o[6]||(o[6]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e("circle",{cx:"12",cy:"7",r:"4"})],-1),e("span",null,"个人信息",-1)])]),e("div",{class:"f-dropdown-item",onClick:s},[...o[7]||(o[7]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"})],-1),e("span",null,"我的工作流",-1)])]),o[9]||(o[9]=e("div",{class:"f-dropdown-divider"},null,-1)),e("div",{class:"f-dropdown-item danger",onClick:B},[...o[8]||(o[8]=[e("svg",{class:"f-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e("polyline",{points:"16 17 21 12 16 7"}),e("line",{x1:"21",y1:"12",x2:"9",y2:"12"})],-1),e("span",null,"退出登录",-1)])])])])):x("",!0)],2)]),J(we,{visible:c.value,"onUpdate:visible":o[0]||(o[0]=r=>c.value=r),onConfirm:P},null,8,["visible"])]))}}),uo=G(Ee,[["__scopeId","data-v-c388168a"]]),Ne=ee("userAgentConfig",()=>{const g=m([]),y=m([]),u=m(""),f=m(!1),C=T(()=>g.value.filter(s=>s.agentConfig&&s.agentConfig.trim()!=="")),b=T(()=>g.value.find(s=>s.agentCode===u.value)),S=T(()=>y.value.find(s=>s.agentCode===u.value));async function l(){f.value=!0;try{g.value=await z.getUserAgentConfigs(),u.value||d()}finally{f.value=!1}}async function c(){try{y.value=await z.getEnabledAgents()}catch(s){console.error("加载运行时 Agent 列表失败:",s)}}async function _(s){await z.updateUserAgentConfig(s),await l()}function A(s){u.value=s,de(s)}function a(){const s=C.value;if(s.length===0)return;const I=(s.findIndex(B=>B.agentCode===u.value)+1)%s.length,M=s[I];M&&A(M.agentCode)}function d(){const s=ce();if(s&&C.value.some(M=>M.agentCode===s)){u.value=s;return}const E=C.value[0];E&&A(E.agentCode)}async function U(){await Promise.all([l(),c()])}function $(){g.value=[],y.value=[],u.value="",ve()}return{userAgentConfigs:g,runtimeAgents:y,selectedAgentCode:u,isLoading:f,configuredAgents:C,currentAgentConfig:b,currentAgent:S,loadUserAgentConfigs:l,loadRuntimeAgents:c,updateUserAgentConfig:_,selectAgent:A,selectNextAgent:a,autoSelectFirstConfiguredAgent:d,initData:U,clearData:$}}),Ie={class:"m-agent-config-modal"},Be={class:"f-modal-body"},De={class:"f-agent-list"},Le=["onClick"],ze={class:"f-agent-card-header"},Oe={class:"f-agent-name"},Pe={key:0,class:"f-config-badge"},Fe={key:0,class:"f-agent-description"},He={class:"f-config-form"},Re={key:0,class:"f-empty-state"},We={key:1,class:"f-config-content"},qe={class:"f-config-header"},Je={class:"f-config-title"},je={key:0,class:"f-config-description"},Ge={key:0,class:"f-form-section"},Ke={class:"f-label"},Xe={key:0,class:"f-required"},Qe={key:5,class:"f-select-wrapper"},Ye=["onUpdate:modelValue","onFocus"],Ze=["value"],eo=["onClick"],oo={key:1,class:"f-no-config"},to={class:"f-form-actions"},no=["disabled"],ao=j({__name:"AgentConfigModal",props:{visible:{type:Boolean}},emits:["update:visible"],setup(g,{emit:y}){const u=g,f=y,C=Ne(),b=m(!1),S=m(!1),l=m(""),c=m(null),_=m([]),A=m({}),a=m({});function d(t){return C.configuredAgents.some(o=>o.agentCode===t)}function U(t){return!t||!A.value[t]?[]:A.value[t].map(o=>({text:o.modelDisplayName,value:o.modelIdentifier}))}function $(t,o){const r=o==="INT"?t.intStartScope:t.floatStartScope,h=o==="INT"?t.intEndScope:t.floatEndScope;return r!==void 0&&h!==void 0?`请输入${r}到${h}之间的数值`:r!==void 0?`请输入大于等于${r}的数值`:h!==void 0?`请输入小于等于${h}的数值`:`请输入${t.description||t.name}`}async function s(t){l.value=t;try{const o=await z.getAgentByCode(t);c.value=o,_.value=o.agentConfigDefinitions||[],A.value={},a.value={},_.value.forEach(h=>{h.type==="BOOLEAN"?a.value[h.name]=!1:h.type==="MODEL"?a.value[h.name]=null:a.value[h.name]=""});const r=C.userAgentConfigs.find(h=>h.agentCode===t);if(r&&r.agentConfig){const h=_.value.filter(k=>k.type==="MODEL"&&k.modelCallingType).map(async k=>{try{const n=await Z.listEnabledModels(k.modelCallingType);A.value[k.modelCallingType]=n}catch(n){console.error(`加载模型列表失败 (${k.modelCallingType}):`,n)}});await Promise.all(h);const O=JSON.parse(r.agentConfig);Object.keys(O).forEach(k=>{k in a.value&&(a.value[k]=O[k])})}}catch(o){console.error("获取 Agent 详情失败:",o),V.error("获取 Agent 详情失败")}}async function E(t){if(!t.modelCallingType){V.error("该配置未指定模型调用方式");return}if(!A.value[t.modelCallingType])try{const o=await Z.listEnabledModels(t.modelCallingType);A.value[t.modelCallingType]=o}catch(o){console.error("获取模型列表失败:",o),V.error("获取模型列表失败")}}function I(){if(!l.value)return V.error("请选择 Agent"),!1;for(const t of _.value){const o=a.value[t.name];if(t.userOverride&&t.require&&(o===""||o===null||o===void 0))return V.error(`请填写${t.description||t.name}`),!1;if(t.type==="INT"&&o!==""&&o!==null&&o!==void 0){const r=Number(o);if(t.intStartScope!==void 0&&r<t.intStartScope)return V.error(`${t.description||t.name}不能小于${t.intStartScope}`),!1;if(t.intEndScope!==void 0&&r>t.intEndScope)return V.error(`${t.description||t.name}不能大于${t.intEndScope}`),!1}if(t.type==="FLOAT"&&o!==""&&o!==null&&o!==void 0){const r=Number(o);if(t.floatStartScope!==void 0&&r<t.floatStartScope)return V.error(`${t.description||t.name}不能小于${t.floatStartScope}`),!1;if(t.floatEndScope!==void 0&&r>t.floatEndScope)return V.error(`${t.description||t.name}不能大于${t.floatEndScope}`),!1}}return!0}async function M(){if(I()){S.value=!0;try{const t={};_.value.forEach(o=>{const r=a.value[o.name];r!==""&&r!==null&&r!==void 0&&(t[o.name]=r)}),await z.updateUserAgentConfig({agentCode:l.value,agentConfig:JSON.stringify(t)}),V.success("保存成功"),await C.loadUserAgentConfigs()}catch(t){console.error("保存失败:",t),V.error("保存失败")}finally{S.value=!1}}}async function B(){b.value=!0;try{await C.initData()}finally{b.value=!1}}function P(){f("update:visible",!1)}return fe(()=>u.visible,t=>{t&&B()}),(t,o)=>{const r=D("van-field"),h=D("van-radio"),O=D("van-radio-group"),k=D("van-popup");return i(),N(k,{show:g.visible,position:"center",style:{width:"90%",maxWidth:"800px",height:"80vh"},round:"",closeable:"",onClose:P,"onUpdate:show":o[0]||(o[0]=n=>f("update:visible",n))},{default:L(()=>[e("div",Ie,[o[6]||(o[6]=e("h3",{class:"f-modal-title"},"Agent 配置管理",-1)),e("div",Be,[e("div",De,[(i(!0),v(H,null,R(pe(C).runtimeAgents,n=>(i(),v("div",{key:n.agentCode,class:oe(["f-agent-card",{active:l.value===n.agentCode}]),onClick:p=>s(n.agentCode)},[e("div",ze,[e("h4",Oe,w(n.agentName),1),d(n.agentCode)?(i(),v("span",Pe,"已配置")):x("",!0)]),n.description?(i(),v("p",Fe,w(n.description),1)):x("",!0)],10,Le))),128))]),e("div",He,[l.value?c.value?(i(),v("div",We,[e("div",qe,[e("h4",Je,w(c.value.agentName)+" 配置",1),c.value.description?(i(),v("p",je,w(c.value.description),1)):x("",!0)]),_.value.length>0?(i(),v("div",Ge,[(i(!0),v(H,null,R(_.value,n=>Y((i(),v("div",{key:n.name,class:"f-form-item"},[e("label",Ke,[W(w(n.description||n.name)+" ",1),n.require?(i(),v("span",Xe,"*")):x("",!0)]),n.type==="STRING"?(i(),N(r,{key:0,modelValue:a.value[n.name],"onUpdate:modelValue":p=>a.value[n.name]=p,placeholder:`请输入${n.description||n.name}`,border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):n.type==="TEXT"?(i(),N(r,{key:1,modelValue:a.value[n.name],"onUpdate:modelValue":p=>a.value[n.name]=p,type:"textarea",placeholder:`请输入${n.description||n.name}`,border:!1,class:"f-input",rows:"3"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):n.type==="INT"?(i(),N(r,{key:2,modelValue:a.value[n.name],"onUpdate:modelValue":p=>a.value[n.name]=p,modelModifiers:{number:!0},type:"number",placeholder:$(n,"INT"),border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):n.type==="FLOAT"?(i(),N(r,{key:3,modelValue:a.value[n.name],"onUpdate:modelValue":p=>a.value[n.name]=p,modelModifiers:{number:!0},type:"number",step:"0.01",placeholder:$(n,"FLOAT"),border:!1,class:"f-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):n.type==="BOOLEAN"?(i(),N(O,{key:4,modelValue:a.value[n.name],"onUpdate:modelValue":p=>a.value[n.name]=p,direction:"horizontal"},{default:L(()=>[J(h,{name:!0},{default:L(()=>[...o[2]||(o[2]=[W("是",-1)])]),_:1}),J(h,{name:!1},{default:L(()=>[...o[3]||(o[3]=[W("否",-1)])]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue"])):n.type==="MODEL"?(i(),v("div",Qe,[Y(e("select",{"onUpdate:modelValue":p=>a.value[n.name]=p,class:"f-select",onFocus:p=>E(n)},[o[4]||(o[4]=e("option",{value:null,disabled:""},"请选择Model",-1)),(i(!0),v(H,null,R(U(n.modelCallingType),p=>(i(),v("option",{key:p.value,value:p.value},w(p.text),9,Ze))),128))],40,Ye),[[me,a.value[n.name]]]),!n.require&&a.value[n.name]!==null&&a.value[n.name]!==""?(i(),v("span",{key:0,class:"f-select-clear",onClick:p=>a.value[n.name]=null}," × ",8,eo)):x("",!0)])):x("",!0)])),[[ge,n.userOverride]])),128))])):(i(),v("div",oo,[...o[5]||(o[5]=[e("p",null,"该 Agent 无需额外配置",-1)])])),e("div",to,[e("button",{class:"f-btn f-btn-primary",disabled:S.value,onClick:M},w(S.value?"保存中...":"保存配置"),9,no)])])):x("",!0):(i(),v("div",Re,[...o[1]||(o[1]=[e("svg",{class:"f-icon-large",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1),e("p",null,"请选择左侧的 Agent 进行配置",-1)])]))])])])]),_:1},8,["show"])}}}),co=G(ao,[["__scopeId","data-v-929973d8"]]);export{co as A,uo as T,Ne as a,ye as u};
