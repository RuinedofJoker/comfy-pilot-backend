import{A as $,a as w,x as K,d as B,k as f,o as i,l as U,m as g,F as I,z as q,_ as x,y as L,e as d,r as N,p as O,b as W,g as l,w as o,i as F,c as H,B as c}from"./index-DUI3biLs.js";import{l as Y,g as z,c as G,u as j,d as J,t as Q}from"./service-C9zbT-OU.js";import{B as X}from"./BaseAdminModal-B7CClbCy.js";import{B as n,a as v,b as M}from"./BaseTextarea-CIO1yuD9.js";import{s as Z}from"./function-call-1j34QfgJ.js";const ee=$("admin",()=>{const s=w([]),p=w(!1),y=K(()=>s.value.filter(r=>r.isEnabled)),h=K(()=>s.value.filter(r=>r.healthStatus==="HEALTHY"));async function S(r){p.value=!0;try{s.value=await Y(r)}finally{p.value=!1}}async function V(r){try{return await z(r)}catch{return null}}async function e(r){const b=await G(r);return s.value.unshift(b),b}async function k(r,b){const C=await j(r,b),P=s.value.findIndex(T=>T.id===r);return P!==-1&&(s.value[P]=C),C}async function A(r){await J(r),s.value=s.value.filter(b=>b.id!==r)}async function _(r){const b=await Q(r),C=s.value.findIndex(P=>P.id===r);return C!==-1&&(s.value[C]=b),b}return{servers:s,isLoading:p,enabledServers:y,healthyServers:h,fetchServers:S,fetchServerById:V,createServer:e,updateServer:k,deleteServer:A,testServerConnection:_}}),ae=["value","disabled"],te={key:0,value:"",disabled:""},le=["value"],se=B({__name:"BaseSelect",props:{modelValue:{},options:{},placeholder:{},disabled:{type:Boolean}},emits:["update:modelValue"],setup(s,{emit:p}){const y=p;function h(S){const V=S.target;y("update:modelValue",V.value)}return(S,V)=>(i(),f("select",{value:s.modelValue,class:"f-base-select",disabled:s.disabled,onChange:h},[s.placeholder?(i(),f("option",te,g(s.placeholder),1)):U("",!0),(i(!0),f(I,null,q(s.options,e=>(i(),f("option",{key:e.value,value:e.value},g(e.label),9,le))),128))],40,ae))}}),E=x(se,[["__scopeId","data-v-fcc92774"]]),oe={class:"f-base-radio-group"},ne=["name","value","checked","disabled"],re={class:"f-radio-label"},de=B({__name:"BaseRadioGroup",props:{modelValue:{type:[String,Number,Boolean]},options:{},name:{},disabled:{type:Boolean}},emits:["update:modelValue"],setup(s,{emit:p}){const y=p;function h(S){const e=S.target.value;e==="true"?y("update:modelValue",!0):e==="false"?y("update:modelValue",!1):y("update:modelValue",e)}return(S,V)=>(i(),f("div",oe,[(i(!0),f(I,null,q(s.options,e=>(i(),f("label",{key:String(e.value),class:L(["f-radio-option",{"is-disabled":s.disabled}])},[d("input",{type:"radio",name:s.name,value:e.value,checked:s.modelValue===e.value,disabled:s.disabled,onChange:h},null,40,ne),d("span",re,g(e.label),1)],2))),128))]))}}),R=x(de,[["__scopeId","data-v-112bbfd0"]]),ie={class:"g-service-management-view"},ue={class:"m-header"},me={class:"m-content"},pe={key:0,class:"f-loading"},ce={key:1,class:"f-services"},ve={class:"f-service-header"},fe={class:"f-service-name"},ye={class:"f-service-url"},he={class:"f-service-desc"},be={class:"f-service-actions"},Se=["disabled","onClick"],Ve=["onClick"],ge=["onClick"],Ce={key:0,class:"f-divider"},Ue=B({__name:"ServiceManagementView",setup(s){const p=ee(),y=w(!1),h=w(null),S=w(!1),V=w(null),e=N({serverKey:"",serverName:"",baseUrl:"",description:"",authMode:"null",apiKey:"",timeoutSeconds:120,maxRetries:3,isEnabled:!0,advancedFeaturesEnabled:!1,connectionType:"LOCAL",sshHost:"",sshPort:22,sshUsername:"",sshAuthType:"PASSWORD",sshPassword:"",sshPrivateKeyPath:"",osType:"",workingDirectory:"~",environmentInitScript:"",pythonCommand:"",comfyuiInstallPath:"",comfyuiStartupPath:""}),k=K(()=>p.servers);async function A(){S.value=!0;try{await p.fetchServers()}catch{c({type:"fail",message:"加载服务列表失败"})}finally{S.value=!1}}async function _(u){V.value=u.id;try{const a=await p.testServerConnection(u.id);c({type:a.healthStatus==="HEALTHY"?"success":"fail",message:a.healthStatus==="HEALTHY"?"连接测试成功":"连接测试失败"})}catch{c({type:"fail",message:"连接测试失败"})}finally{V.value=null}}async function r(u){try{const a=await p.fetchServerById(u.id);if(!a){c({type:"fail",message:"获取服务详情失败"});return}if(h.value=a,e.serverKey=a.serverKey,e.serverName=a.serverName,e.baseUrl=a.baseUrl,e.description=a.description||"",e.authMode=a.authMode??"null",e.apiKey=a.apiKey||"",e.timeoutSeconds=a.timeoutSeconds||120,e.maxRetries=a.maxRetries||3,e.isEnabled=a.isEnabled,a.advancedFeaturesEnabled&&a.advancedFeatures){e.advancedFeaturesEnabled=!0;const m=a.advancedFeatures;e.connectionType=m.connectionType||"LOCAL",e.osType=m.osType||"",e.workingDirectory=m.workingDirectory||"~",e.environmentInitScript=m.environmentInitScript||"",e.pythonCommand=m.pythonCommand||"",m.sshConfig&&(e.sshHost=m.sshConfig.host||"",e.sshPort=m.sshConfig.port||22,e.sshUsername=m.sshConfig.username||"",e.sshAuthType=m.sshConfig.authType||"PASSWORD",e.sshPassword=m.sshConfig.password||"",e.sshPrivateKeyPath=m.sshConfig.privateKeyPath||""),m.directoryConfig&&(e.comfyuiInstallPath=m.directoryConfig.comfyuiInstallPath||"")}else e.advancedFeaturesEnabled=!1;y.value=!0}catch{c({type:"fail",message:"获取服务详情失败"})}}async function b(u){try{await Z({title:"确认删除",message:`确定要删除服务"${u.serverName}"吗？`}),await p.deleteServer(u.id),c({type:"success",message:"删除成功"})}catch{}}async function C(){if(!e.serverName.trim()||!e.baseUrl.trim()){c({type:"fail",message:"请填写必填项"});return}if(e.authMode==="basic_auth"&&!e.apiKey.trim()){c({type:"fail",message:"认证模式为Basic Auth时，API密钥必填"});return}if(e.advancedFeaturesEnabled){if(!e.workingDirectory.trim()){c({type:"fail",message:"工作目录必填"});return}if(!e.comfyuiInstallPath.trim()){c({type:"fail",message:"ComfyUI安装路径必填"});return}if(e.connectionType==="SSH"){if(!e.sshHost.trim()||!e.sshUsername.trim()){c({type:"fail",message:"SSH配置中主机和用户名必填"});return}if(e.sshAuthType==="PASSWORD"&&!e.sshPassword.trim()){c({type:"fail",message:"SSH密码认证时密码必填"});return}}}try{const u={serverName:e.serverName,baseUrl:e.baseUrl,description:e.description||void 0,authMode:e.authMode,apiKey:e.authMode==="basic_auth"?e.apiKey:void 0,timeoutSeconds:e.timeoutSeconds,maxRetries:e.maxRetries,isEnabled:e.isEnabled};!h.value&&e.serverKey.trim()&&(u.serverKey=e.serverKey),e.advancedFeaturesEnabled&&(u.advancedFeaturesEnabled=!0,u.advancedFeatures={connectionType:e.connectionType,osType:e.osType||void 0,workingDirectory:e.workingDirectory,environmentInitScript:e.environmentInitScript||void 0,pythonCommand:e.pythonCommand||void 0,directoryConfig:{comfyuiInstallPath:e.comfyuiInstallPath||void 0}},e.connectionType==="SSH"&&(u.advancedFeatures.sshConfig={host:e.sshHost,port:e.sshPort,username:e.sshUsername,authType:e.sshAuthType,password:e.sshAuthType==="PASSWORD"?e.sshPassword:void 0,privateKeyPath:e.sshAuthType==="KEY"?e.sshPrivateKeyPath:void 0})),h.value?(await p.updateServer(h.value.id,u),c({type:"success",message:"更新成功"})):(await p.createServer(u),c({type:"success",message:"创建成功"})),T(),y.value=!1}catch{c({type:"fail",message:"操作失败"})}}function P(){T()}function T(){e.serverKey="",e.serverName="",e.baseUrl="",e.description="",e.authMode="null",e.apiKey="",e.timeoutSeconds=120,e.maxRetries=3,e.isEnabled=!0,e.advancedFeaturesEnabled=!1,e.connectionType="LOCAL",e.sshHost="",e.sshPort=22,e.sshUsername="",e.sshAuthType="PASSWORD",e.sshPassword="",e.sshPrivateKeyPath="",e.osType="",e.workingDirectory="~",e.environmentInitScript="",e.pythonCommand="",e.comfyuiInstallPath="",h.value=null}return O(()=>{A()}),(u,a)=>{const m=W("van-loading");return i(),f("div",ie,[d("div",ue,[a[24]||(a[24]=d("h1",null,"ComfyUI 服务管理",-1)),d("button",{class:"f-btn f-btn-primary",onClick:a[0]||(a[0]=t=>y.value=!0)}," + 添加服务 ")]),d("div",me,[S.value?(i(),f("div",pe,[l(m,{type:"spinner",color:"#4a9eff",size:"40"},{default:o(()=>[...a[25]||(a[25]=[F("加载中...",-1)])]),_:1})])):(i(),f("div",ce,[(i(!0),f(I,null,q(k.value,t=>(i(),f("div",{key:t.id,class:"f-service-card"},[d("div",ve,[d("div",null,[d("div",fe,g(t.serverName),1),d("div",ye,g(t.baseUrl),1)]),d("span",{class:L(["f-status",t.healthStatus==="HEALTHY"?"online":"offline"])},[a[26]||(a[26]=d("span",{class:"f-status-dot"},null,-1)),F(" "+g(t.healthStatus==="HEALTHY"?"在线":"离线"),1)],2)]),d("div",he,g(t.description||"暂无描述"),1),d("div",be,[d("button",{class:"f-btn",disabled:V.value===t.id,onClick:D=>_(t)},g(V.value===t.id?"测试中...":"测试"),9,Se),d("button",{class:"f-btn",onClick:D=>r(t)},"编辑",8,Ve),d("button",{class:"f-btn",onClick:D=>b(t)},"删除",8,ge)])]))),128))]))]),l(X,{modelValue:y.value,"onUpdate:modelValue":a[23]||(a[23]=t=>y.value=t),title:h.value?"编辑服务":"添加服务","close-on-mask":!1,onConfirm:C,onCancel:P},{default:o(()=>[l(n,{label:"服务标识符"},{default:o(()=>[l(v,{modelValue:e.serverKey,"onUpdate:modelValue":a[1]||(a[1]=t=>e.serverKey=t),placeholder:"自动生成",disabled:!!h.value},null,8,["modelValue","disabled"])]),_:1}),l(n,{label:"服务名称",required:""},{default:o(()=>[l(v,{modelValue:e.serverName,"onUpdate:modelValue":a[2]||(a[2]=t=>e.serverName=t),placeholder:"生产环境 ComfyUI",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"启用状态"},{default:o(()=>[l(R,{modelValue:e.isEnabled,"onUpdate:modelValue":a[3]||(a[3]=t=>e.isEnabled=t),options:[{label:"启用",value:!0},{label:"禁用",value:!1}],name:"isEnabled"},null,8,["modelValue"])]),_:1}),l(n,{label:"服务地址",hint:"完整的 ComfyUI 服务 URL",required:""},{default:o(()=>[l(v,{modelValue:e.baseUrl,"onUpdate:modelValue":a[4]||(a[4]=t=>e.baseUrl=t),type:"url",placeholder:"http://192.168.1.100:8188",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"描述"},{default:o(()=>[l(M,{modelValue:e.description,"onUpdate:modelValue":a[5]||(a[5]=t=>e.description=t),placeholder:"服务描述...",rows:3},null,8,["modelValue"])]),_:1}),l(n,{label:"认证模式",required:""},{default:o(()=>[l(E,{modelValue:e.authMode,"onUpdate:modelValue":a[6]||(a[6]=t=>e.authMode=t),options:[{label:"无认证",value:"null"},{label:"Basic Auth",value:"basic_auth"}]},null,8,["modelValue"])]),_:1}),e.authMode==="basic_auth"?(i(),H(n,{key:0,label:"API密钥",required:""},{default:o(()=>[l(v,{modelValue:e.apiKey,"onUpdate:modelValue":a[7]||(a[7]=t=>e.apiKey=t),type:"password",placeholder:"请输入API密钥",required:""},null,8,["modelValue"])]),_:1})):U("",!0),l(n,{label:"超时时间(秒)"},{default:o(()=>[l(v,{modelValue:e.timeoutSeconds,"onUpdate:modelValue":a[8]||(a[8]=t=>e.timeoutSeconds=t),modelModifiers:{number:!0},type:"number",placeholder:"120"},null,8,["modelValue"])]),_:1}),l(n,{label:"最大重试次数"},{default:o(()=>[l(v,{modelValue:e.maxRetries,"onUpdate:modelValue":a[9]||(a[9]=t=>e.maxRetries=t),modelModifiers:{number:!0},type:"number",placeholder:"3"},null,8,["modelValue"])]),_:1}),a[28]||(a[28]=d("div",{class:"f-divider"},"高级选项",-1)),l(n,{label:"启用高级功能"},{default:o(()=>[l(R,{modelValue:e.advancedFeaturesEnabled,"onUpdate:modelValue":a[10]||(a[10]=t=>e.advancedFeaturesEnabled=t),options:[{label:"否",value:!1},{label:"是",value:!0}],name:"advancedFeaturesEnabled"},null,8,["modelValue"])]),_:1}),e.advancedFeaturesEnabled?(i(),f(I,{key:1},[l(n,{label:"连接类型",required:""},{default:o(()=>[l(E,{modelValue:e.connectionType,"onUpdate:modelValue":a[11]||(a[11]=t=>e.connectionType=t),options:[{label:"本地",value:"LOCAL"},{label:"SSH",value:"SSH"}]},null,8,["modelValue"])]),_:1}),e.connectionType==="SSH"?(i(),f("div",Ce,"SSH连接配置")):U("",!0),e.connectionType==="SSH"?(i(),f(I,{key:1},[l(n,{label:"SSH主机",required:""},{default:o(()=>[l(v,{modelValue:e.sshHost,"onUpdate:modelValue":a[12]||(a[12]=t=>e.sshHost=t),placeholder:"192.168.1.100",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"SSH端口",required:""},{default:o(()=>[l(v,{modelValue:e.sshPort,"onUpdate:modelValue":a[13]||(a[13]=t=>e.sshPort=t),modelModifiers:{number:!0},type:"number",placeholder:"22",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"SSH用户名",required:""},{default:o(()=>[l(v,{modelValue:e.sshUsername,"onUpdate:modelValue":a[14]||(a[14]=t=>e.sshUsername=t),placeholder:"root",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"SSH认证方式",required:""},{default:o(()=>[l(E,{modelValue:e.sshAuthType,"onUpdate:modelValue":a[15]||(a[15]=t=>e.sshAuthType=t),options:[{label:"密码",value:"PASSWORD"}]},null,8,["modelValue"])]),_:1}),e.sshAuthType==="PASSWORD"?(i(),H(n,{key:0,label:"SSH密码",required:""},{default:o(()=>[l(v,{modelValue:e.sshPassword,"onUpdate:modelValue":a[16]||(a[16]=t=>e.sshPassword=t),type:"password",placeholder:"请输入SSH密码",required:""},null,8,["modelValue"])]),_:1})):U("",!0),e.sshAuthType==="KEY"?(i(),H(n,{key:1,label:"私钥路径"},{default:o(()=>[l(v,{modelValue:e.sshPrivateKeyPath,"onUpdate:modelValue":a[17]||(a[17]=t=>e.sshPrivateKeyPath=t),placeholder:"/path/to/private_key"},null,8,["modelValue"])]),_:1})):U("",!0)],64)):U("",!0),a[27]||(a[27]=d("div",{class:"f-divider"},"ComfyUI目录配置",-1)),l(n,{label:"工作目录（连接到终端后的默认目录）",required:""},{default:o(()=>[l(v,{modelValue:e.workingDirectory,"onUpdate:modelValue":a[18]||(a[18]=t=>e.workingDirectory=t),placeholder:"~",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"Python命令（ComfyUI启动使用的Python位置）"},{default:o(()=>[l(v,{modelValue:e.pythonCommand,"onUpdate:modelValue":a[19]||(a[19]=t=>e.pythonCommand=t),placeholder:"/path/to/python 或 C:/ComfyUI_windows_portable/python_embeded/python.exe 等"},null,8,["modelValue"])]),_:1}),l(n,{label:"环境初始化脚本"},{default:o(()=>[l(M,{modelValue:e.environmentInitScript,"onUpdate:modelValue":a[20]||(a[20]=t=>e.environmentInitScript=t),placeholder:`#!/bin/bash
source /path/to/venv/bin/activate 等`,rows:4},null,8,["modelValue"])]),_:1}),l(n,{label:"ComfyUI安装路径",required:""},{default:o(()=>[l(v,{modelValue:e.comfyuiInstallPath,"onUpdate:modelValue":a[21]||(a[21]=t=>e.comfyuiInstallPath=t),placeholder:"/path/to/ComfyUI 或 C:/ComfyUI_windows_portable 等",required:""},null,8,["modelValue"])]),_:1}),l(n,{label:"ComfyUI启动脚本路径"},{default:o(()=>[l(v,{modelValue:e.comfyuiStartupPath,"onUpdate:modelValue":a[22]||(a[22]=t=>e.comfyuiStartupPath=t),placeholder:"/path/to/ComfyUI/run.sh 或 /path/to/ComfyUI/run_amd_gpu.bat 等",required:""},null,8,["modelValue"])]),_:1})],64)):U("",!0)]),_:1},8,["modelValue","title"])])}}}),Ae=x(Ue,[["__scopeId","data-v-bfd9b639"]]);export{Ae as default};
