<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æµ‹è¯• 2: postMessage é€šä¿¡æµ‹è¯•</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    padding: 20px;
    background: #f5f6fa;
}

.test-container {
    max-width: 1400px;
    margin: 0 auto;
}

.test-header {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.test-header h1 {
    font-size: 24px;
    color: #2c3e50;
    margin-bottom: 10px;
}

.control-panel {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.control-panel h2 {
    font-size: 18px;
    color: #2c3e50;
    margin-bottom: 16px;
}

.button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.iframe-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.iframe-wrapper {
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
    height: 600px;
}

iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.message-log {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message-log h2 {
    font-size: 18px;
    color: #2c3e50;
    margin-bottom: 16px;
}

.log-container {
    background: #2c3e50;
    color: #ecf0f1;
    padding: 16px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    max-height: 300px;
    overflow-y: auto;
}

.log-item {
    margin-bottom: 8px;
    padding: 4px 0;
    border-bottom: 1px solid #34495e;
}

.log-time {
    color: #95a5a6;
    margin-right: 8px;
}

.log-sent {
    color: #3498db;
}

.log-received {
    color: #2ecc71;
}

.log-error {
    color: #e74c3c;
}
</style>
</head>
<body>
<div class="test-container">
    <div class="test-header">
        <h1>ğŸ§ª æµ‹è¯• 2: postMessage é€šä¿¡æµ‹è¯•</h1>
        <p>æµ‹è¯•ç›®æ ‡ï¼šéªŒè¯çˆ¶é¡µé¢ä¸ ComfyUI iframe ä¹‹é—´çš„ postMessage é€šä¿¡æ˜¯å¦æ­£å¸¸ã€‚</p>
    </div>

    <div class="control-panel">
        <h2>ğŸ“¤ å‘é€æ¶ˆæ¯åˆ° iframe</h2>
        <div class="button-group">
            <button class="btn btn-primary" onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button class="btn btn-success" onclick="sendGetWorkflow()">è¯·æ±‚è·å–å·¥ä½œæµ</button>
            <button class="btn btn-warning" onclick="sendCustomMessage()">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>
        </div>
    </div>

    <div class="iframe-container">
        <h2 style="margin-bottom: 16px; color: #2c3e50;">ComfyUI iframe</h2>
        <div class="iframe-wrapper">
            <iframe
                src="http://127.0.0.1:8188/"
                id="comfyuiFrame"
            ></iframe>
        </div>
    </div>

    <div class="message-log">
        <h2>ğŸ“‹ æ¶ˆæ¯æ—¥å¿—</h2>
        <div class="log-container" id="messageLog">
            <div class="log-item">
                <span class="log-time">[00:00:00]</span>
                <span>ç­‰å¾…æ¶ˆæ¯...</span>
            </div>
        </div>
    </div>
</div>

<script>
let startTime = Date.now();

function getTimestamp() {
    const elapsed = Date.now() - startTime;
    const seconds = Math.floor(elapsed / 1000);
    const ms = elapsed % 1000;
    return `[${String(seconds).padStart(2, '0')}:${String(ms).padStart(3, '0')}]`;
}

function addLog(message, type = 'info') {
    const messageLog = document.getElementById('messageLog');
    const logItem = document.createElement('div');
    logItem.className = 'log-item';

    const timestamp = document.createElement('span');
    timestamp.className = 'log-time';
    timestamp.textContent = getTimestamp();

    const content = document.createElement('span');
    content.className = `log-${type}`;
    content.textContent = message;

    logItem.appendChild(timestamp);
    logItem.appendChild(content);
    messageLog.appendChild(logItem);

    messageLog.scrollTop = messageLog.scrollHeight;
}

// ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
window.addEventListener('message', function(event) {
    addLog(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ from ${event.origin}`, 'received');
    addLog(`   æ•°æ®: ${JSON.stringify(event.data)}`, 'received');
});

// å‘é€æµ‹è¯•æ¶ˆæ¯
function sendTestMessage() {
    const iframe = document.getElementById('comfyuiFrame');
    const message = {
        type: 'TEST',
        payload: { message: 'Hello from parent!' },
        timestamp: Date.now()
    };

    iframe.contentWindow.postMessage(message, '*');
    addLog(`ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯: ${JSON.stringify(message)}`, 'sent');
}

// è¯·æ±‚è·å–å·¥ä½œæµ
function sendGetWorkflow() {
    const iframe = document.getElementById('comfyuiFrame');
    const message = {
        type: 'GET_WORKFLOW',
        timestamp: Date.now()
    };

    iframe.contentWindow.postMessage(message, '*');
    addLog(`ğŸ“¤ è¯·æ±‚è·å–å·¥ä½œæµ`, 'sent');
}

// å‘é€è‡ªå®šä¹‰æ¶ˆæ¯
function sendCustomMessage() {
    const customMessage = prompt('è¯·è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯ï¼ˆJSON æ ¼å¼ï¼‰ï¼š', '{"type": "CUSTOM", "data": "test"}');
    if (customMessage) {
        try {
            const message = JSON.parse(customMessage);
            const iframe = document.getElementById('comfyuiFrame');
            iframe.contentWindow.postMessage(message, '*');
            addLog(`ğŸ“¤ å‘é€è‡ªå®šä¹‰æ¶ˆæ¯: ${customMessage}`, 'sent');
        } catch (e) {
            addLog(`âŒ JSON è§£æé”™è¯¯: ${e.message}`, 'error');
        }
    }
}

addLog('ğŸš€ postMessage ç›‘å¬å™¨å·²å¯åŠ¨', 'info');
</script>
</body>
</html>
