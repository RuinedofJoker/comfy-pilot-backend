# 实体基类使用说明

## 1. 概述

本项目已创建完整的 DDD 架构实体基类体系，包括领域实体、持久化对象、DTO、异常处理等。

## 2. 基类清单

### 2.1 核心基类

| 基类 | 路径 | 说明 |
|------|------|------|
| **BaseEntity** | `common.domain.BaseEntity` | 领域实体基类 |
| **BasePO** | `common.infrastructure.persistence.po.BasePO` | 持久化对象基类 |
| **BaseDTO** | `common.application.dto.BaseDTO` | DTO 基类 |
| **PageRequest** | `common.application.dto.PageRequest` | 分页请求基类 |
| **PageResponse** | `common.application.dto.PageResponse` | 分页响应基类 |
| **Result** | `common.interfaces.response.Result` | 统一响应结果 |

### 2.2 异常类

| 异常类 | 说明 | HTTP 状态码 |
|--------|------|-------------|
| **BusinessException** | 业务异常基类 | 500 |
| **ValidationException** | 参数验证异常 | 400 |
| **UnauthorizedException** | 未授权异常 | 401 |
| **ResourceNotFoundException** | 资源未找到异常 | 404 |

### 2.3 配置类

| 配置类 | 说明 |
|--------|------|
| **MybatisPlusMetaObjectHandler** | 字段自动填充处理器 |
| **GlobalExceptionHandler** | 全局异常处理器 |

## 3. 使用示例

### 3.1 创建领域实体

```java
package org.joker.comfypilot.workflow.domain.entity;

import lombok.Data;
import lombok.EqualsAndHashCode;
import org.joker.comfypilot.common.domain.BaseEntity;

import java.time.LocalDateTime;

@Data
@EqualsAndHashCode(callSuper = true)
public class Workflow extends BaseEntity<Long> {

    private Long id;
    private String name;
    private String description;
    private String status;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    @Override
    public Long getId() {
        return id;
    }

    @Override
    public void setId(Long id) {
        this.id = id;
    }

    @Override
    public LocalDateTime getCreatedAt() {
        return createdAt;
    }

    @Override
    public LocalDateTime getUpdatedAt() {
        return updatedAt;
    }
}
```

### 3.2 创建持久化对象（PO）

```java
package org.joker.comfypilot.workflow.infrastructure.persistence.po;

import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import lombok.EqualsAndHashCode;
import org.joker.comfypilot.common.infrastructure.persistence.po.BasePO;

@Data
@EqualsAndHashCode(callSuper = true)
@TableName("workflow")
public class WorkflowPO extends BasePO {

    /**
     * 工作流名称
     */
    private String name;

    /**
     * 工作流描述
     */
    private String description;

    /**
     * 工作流状态
     */
    private String status;

    /**
     * 缩略图URL
     */
    private String thumbnailUrl;
}
```

**说明**：
- 继承 `BasePO` 后自动拥有：`id`, `createdAt`, `updatedAt`, `createdBy`, `updatedBy`, `deleted`
- 这些字段会自动填充，无需手动设置

### 3.3 创建 DTO

```java
package org.joker.comfypilot.workflow.application.dto;

import lombok.Data;
import lombok.EqualsAndHashCode;
import org.joker.comfypilot.common.application.dto.BaseDTO;

@Data
@EqualsAndHashCode(callSuper = true)
public class WorkflowDTO extends BaseDTO {

    private String name;
    private String description;
    private String status;
    private String thumbnailUrl;
}
```

### 3.4 分页查询

#### 请求 DTO

```java
package org.joker.comfypilot.workflow.application.dto;

import lombok.Data;
import lombok.EqualsAndHashCode;
import org.joker.comfypilot.common.application.dto.PageRequest;

@Data
@EqualsAndHashCode(callSuper = true)
public class WorkflowPageRequest extends PageRequest {

    private String name;
    private String status;
}
```

#### Service 层

```java
@Service
public class WorkflowApplicationService {

    @Autowired
    private WorkflowMapper workflowMapper;

    public PageResponse<WorkflowDTO> pageQuery(WorkflowPageRequest request) {
        // 校验分页参数
        request.validate();

        // 构建查询条件
        Page<WorkflowPO> page = new Page<>(request.getPageNum(), request.getPageSize());
        LambdaQueryWrapper<WorkflowPO> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(StringUtils.hasText(request.getName()),
                     WorkflowPO::getName, request.getName());
        wrapper.eq(StringUtils.hasText(request.getStatus()),
                   WorkflowPO::getStatus, request.getStatus());

        // 执行查询
        Page<WorkflowPO> result = workflowMapper.selectPage(page, wrapper);

        // 转换为 DTO
        List<WorkflowDTO> dtoList = result.getRecords().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());

        // 返回分页响应
        return new PageResponse<>(dtoList, result.getTotal(),
                                  request.getPageNum(), request.getPageSize());
    }
}
```

### 3.5 Controller 层统一响应

```java
@RestController
@RequestMapping("/api/v1/workflows")
public class WorkflowController {

    @Autowired
    private WorkflowApplicationService workflowApplicationService;

    @GetMapping
    public Result<PageResponse<WorkflowDTO>> pageQuery(WorkflowPageRequest request) {
        PageResponse<WorkflowDTO> response = workflowApplicationService.pageQuery(request);
        return Result.success(response);
    }

    @GetMapping("/{id}")
    public Result<WorkflowDTO> getById(@PathVariable Long id) {
        WorkflowDTO workflow = workflowApplicationService.getById(id);
        if (workflow == null) {
            throw new ResourceNotFoundException("Workflow", id);
        }
        return Result.success(workflow);
    }

    @PostMapping
    public Result<WorkflowDTO> create(@RequestBody WorkflowDTO dto) {
        WorkflowDTO created = workflowApplicationService.create(dto);
        return Result.success("创建成功", created);
    }
}
```

### 3.6 异常处理

```java
@Service
public class WorkflowApplicationService {

    public WorkflowDTO getById(Long id) {
        WorkflowPO po = workflowMapper.selectById(id);
        if (po == null) {
            // 抛出资源未找到异常，会被全局异常处理器捕获
            throw new ResourceNotFoundException("Workflow", id);
        }
        return convertToDTO(po);
    }

    public void validateWorkflow(WorkflowDTO dto) {
        if (!StringUtils.hasText(dto.getName())) {
            // 抛出参数验证异常
            throw new ValidationException("工作流名称不能为空");
        }
    }
}
```

## 4. 自动填充字段

### 4.1 自动填充的字段

继承 `BasePO` 的实体会自动填充以下字段：

| 字段 | 插入时 | 更新时 | 说明 |
|------|--------|--------|------|
| `createdAt` | ✅ | ❌ | 创建时间 |
| `updatedAt` | ✅ | ✅ | 更新时间 |
| `createdBy` | ✅ | ❌ | 创建人ID |
| `updatedBy` | ✅ | ✅ | 更新人ID |

### 4.2 示例

```java
// 插入数据
WorkflowPO po = new WorkflowPO();
po.setName("测试工作流");
workflowMapper.insert(po);
// createdAt, updatedAt, createdBy, updatedBy 会自动填充

// 更新数据
po.setName("修改后的名称");
workflowMapper.updateById(po);
// updatedAt, updatedBy 会自动更新
```

## 5. 响应格式

### 5.1 成功响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "name": "测试工作流",
    "createdAt": "2026-01-14T19:30:45"
  },
  "traceId": "abc123def456",
  "timestamp": 1705234245123
}
```

### 5.2 失败响应

```json
{
  "code": 404,
  "message": "Workflow not found: 999",
  "data": null,
  "traceId": "abc123def456",
  "timestamp": 1705234245123
}
```

### 5.3 分页响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [
      {
        "id": 1,
        "name": "工作流1"
      }
    ],
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "totalPages": 10,
    "hasNext": true,
    "hasPrevious": false
  },
  "traceId": "abc123def456",
  "timestamp": 1705234245123
}
```

## 6. 最佳实践

### 6.1 分层职责

- **Entity（领域实体）**：包含业务逻辑和业务规则
- **PO（持久化对象）**：仅用于数据库映射，不包含业务逻辑
- **DTO**：用于层间数据传输，面向接口设计

### 6.2 对象转换

```java
// PO → Entity
private Workflow convertToEntity(WorkflowPO po) {
    Workflow entity = new Workflow();
    BeanUtils.copyProperties(po, entity);
    return entity;
}

// Entity → DTO
private WorkflowDTO convertToDTO(Workflow entity) {
    WorkflowDTO dto = new WorkflowDTO();
    BeanUtils.copyProperties(entity, dto);
    return dto;
}

// PO → DTO（直接转换，跳过 Entity）
private WorkflowDTO convertToDTO(WorkflowPO po) {
    WorkflowDTO dto = new WorkflowDTO();
    BeanUtils.copyProperties(po, dto);
    return dto;
}
```

### 6.3 异常处理原则

1. **业务异常**：使用 `BusinessException` 及其子类
2. **参数验证**：使用 `ValidationException`
3. **资源未找到**：使用 `ResourceNotFoundException`
4. **系统异常**：让其抛出，由全局异常处理器统一处理

### 6.4 日志记录

```java
@Service
public class WorkflowApplicationService {

    private static final Logger log = LoggerFactory.getLogger(WorkflowApplicationService.class);

    public WorkflowDTO create(WorkflowDTO dto) {
        log.info("Creating workflow: {}", dto.getName());
        try {
            // 业务逻辑
            return result;
        } catch (Exception e) {
            log.error("Failed to create workflow", e);
            throw new BusinessException("创建工作流失败");
        }
    }
}
```

---

**文档版本**：v1.0
**创建日期**：2026-01-14
**维护者**：开发团队
