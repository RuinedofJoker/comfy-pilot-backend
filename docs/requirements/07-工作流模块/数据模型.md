# 工作流模块 - 数据模型

> 本文档定义工作流模块相关的数据表设计

## 数据表

### workflow - 工作流表

**表名**: `workflow`

**表说明**: 存储平台工作流的基本信息和当前激活版本内容

#### 字段定义

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY | - | 主键ID（雪花算法） |
| workflow_name | VARCHAR(100) | NOT NULL | - | 工作流名称 |
| description | VARCHAR(500) | NULL | - | 工作流描述 |
| comfyui_server_id | BIGINT | NOT NULL | - | 所属ComfyUI服务ID |
| comfyui_server_key | VARCHAR(100) | NOT NULL | - | 所属ComfyUI服务唯一标识符 |
| active_content | TEXT | NULL | - | 当前激活版本的内容（JSON格式） |
| active_content_hash | VARCHAR(64) | NULL | - | 激活内容的SHA-256哈希值 |
| thumbnail_url | VARCHAR(500) | NULL | - | 工作流缩略图URL |
| is_locked | BOOLEAN | NOT NULL | FALSE | 是否锁定 |
| locked_by | BIGINT | NULL | - | 锁定人ID |
| locked_at | TIMESTAMP | NULL | - | 锁定时间 |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | NOT NULL | - | 创建人ID |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |
| update_by | BIGINT | NOT NULL | - | 更新人ID |
| is_deleted | BIGINT | NOT NULL | 0 | 逻辑删除标记（0-未删除，非0-删除时的时间戳） |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | PRIMARY KEY | id | 主键索引 |
| idx_workflow_server_id | INDEX | comfyui_server_id | ComfyUI服务ID索引 |
| idx_workflow_server_key | INDEX | comfyui_server_key | ComfyUI服务Key索引 |
| idx_workflow_create_by | INDEX | create_by | 创建人索引 |
| idx_workflow_is_locked | INDEX | is_locked | 锁定状态索引 |

#### 字段说明

**active_content（激活内容）**:
- 存储当前激活版本的完整工作流内容（JSON格式）
- 初始为空（NULL）
- 每次保存时（用户点击保存按钮或Ctrl+S）更新此字段
- 与工作流是一对一关系，直接存储在工作流表中

**active_content_hash（激活内容哈希）**:
- 使用SHA-256算法对active_content生成的哈希值
- 用于快速比对内容是否发生变化
- 在生成版本时用于判断是否需要创建新版本

**is_locked（锁定状态）**:
- 工作流编辑时的锁定机制
- 防止多人同时编辑导致冲突
- 锁定时记录locked_by和locked_at

---

### workflow_version - 工作流版本表

**表名**: `workflow_version`

**表说明**: 存储工作流的历史版本，每次Agent对话修改工作流时生成

#### 字段定义

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY | - | 主键ID（雪花算法） |
| workflow_id | BIGINT | NOT NULL | - | 所属工作流ID |
| version_number | INT | NOT NULL | - | 版本号（从1开始递增） |
| content | TEXT | NOT NULL | - | 版本内容（JSON格式） |
| content_hash | VARCHAR(64) | NOT NULL | - | 内容的SHA-256哈希值 |
| change_summary | VARCHAR(500) | NULL | - | 变更摘要（Agent生成） |
| session_id | BIGINT | NULL | - | 关联的会话ID（如果是Agent对话生成） |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | NOT NULL | - | 创建人ID |
| is_deleted | BIGINT | NOT NULL | 0 | 逻辑删除标记（0-未删除，非0-删除时的时间戳） |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | PRIMARY KEY | id | 主键索引 |
| uk_workflow_version | UNIQUE | workflow_id, version_number | 工作流ID+版本号唯一索引 |
| idx_version_workflow_id | INDEX | workflow_id | 工作流ID索引 |
| idx_version_content_hash | INDEX | content_hash | 内容哈希索引（用于查找相同内容） |
| idx_version_session_id | INDEX | session_id | 会话ID索引 |
| idx_version_create_time | INDEX | create_time | 创建时间索引 |

#### 字段说明

**version_number（版本号）**:
- 从1开始递增
- 同一个workflow_id下的版本号唯一
- 通过UNIQUE索引保证唯一性

**content_hash（内容哈希）**:
- 使用SHA-256算法对content生成的哈希值
- 用于快速判断两个版本内容是否相同
- 如果哈希值相同，再比对content确认是否完全一致
- 相同内容可以复用已有版本，不创建新版本

**change_summary（变更摘要）**:
- Agent对话时生成的变更说明
- 帮助用户理解每个版本的改动内容
- 可选字段

**session_id（会话ID）**:
- 关联到会话模块的chat_session表
- 记录此版本是在哪次Agent对话中生成的
- 可选字段（手动保存时为NULL）

#### 版本生成规则

1. **Agent对话修改工作流时**:
   - 计算修改后内容的哈希值
   - 查询是否存在相同哈希值的版本
   - 如果存在且内容完全一致，复用该版本
   - 如果不存在，创建新版本（version_number自动递增）

2. **版本只读性**:
   - 版本一旦创建就不能修改
   - 保证版本历史的完整性和可追溯性

---

**最后更新**: 2026-01-16
