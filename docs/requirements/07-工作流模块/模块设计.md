# 工作流模块 - 模块设计

> 本模块负责工作流CRUD、版本管理、锁定控制

## 模块概述

**模块名称**: 工作流模块 (workflow)

**包路径**: `org.joker.comfypilot.workflow`

**实现状态**: ⏳ 待实现

---

## 模块功能

### 核心功能

#### 工作流管理
1. **工作流CRUD**
   - ⏳ 创建工作流
   - ⏳ 查询工作流列表（支持过滤）
   - ⏳ 查询工作流详情
   - ⏳ 更新工作流信息
   - ⏳ 删除工作流

2. **工作流内容管理**
   - ⏳ 保存工作流内容（更新active_content）
   - ⏳ 获取工作流内容
   - ⏳ 内容哈希计算

3. **工作流锁定控制**
   - ⏳ 锁定工作流（编辑时）
   - ⏳ 解锁工作流
   - ⏳ 检查锁定状态

#### 版本管理
1. **版本创建**
   - ⏳ Agent对话后创建版本
   - ⏳ 内容哈希去重
   - ⏳ 版本号自动递增

2. **版本查询**
   - ⏳ 查询工作流的版本列表
   - ⏳ 查询版本详情
   - ⏳ 版本内容对比

### 依赖模块
- **ComfyUI服务模块(cfsvr)**: 工作流关联ComfyUI服务
- **会话模块(session)**: 版本关联Agent对话会话（待实现）

---

## 业务逻辑

### 工作流与ComfyUI服务的关系

**关联关系**：
- 一个ComfyUI服务对应多个工作流（一对多）
- 每个工作流必须关联一个ComfyUI服务
- 工作流记录服务的ID和唯一标识符（server_id + server_key）

**业务规则**：
- 创建工作流时必须指定ComfyUI服务
- 删除ComfyUI服务时需要检查是否有关联的工作流
- 工作流可以查询所属的ComfyUI服务信息

---

### 激活内容机制

**激活内容（active_content）**：
- 存储当前工作流的最新内容
- 与工作流是一对一关系，直接存储在workflow表中
- 初始状态为空（NULL）

**保存机制**：
- 用户点击保存按钮或按Ctrl+S触发保存
- 保存时更新active_content字段
- 同时计算并更新active_content_hash

**哈希计算**：
- 使用SHA-256算法对内容生成哈希值
- 用于快速判断内容是否发生变化
- 在版本生成时用于去重判断

---

### 版本管理机制

**版本创建时机**：
- 仅在Agent对话修改工作流内容时创建版本
- 用户手动保存（Ctrl+S）不创建版本，只更新active_content

**版本生成流程**：
1. Agent对话完成后，计算修改后内容的SHA-256哈希值
2. 查询是否存在相同哈希值的版本
3. 如果哈希值相同，进一步比对完整内容
4. 如果内容完全一致，复用已有版本（不创建新版本）
5. 如果内容不同，创建新版本（version_number自动递增）

**版本去重策略**：
- 使用content_hash快速判断（O(1)复杂度）
- 哈希值相同时再比对完整内容（确保准确性）
- 避免存储重复的版本内容

**版本只读性**：
- 版本一旦创建就不能修改
- 保证版本历史的完整性和可追溯性
- 版本号严格递增，不允许跳号

---

### 工作流锁定机制

**锁定目的**：
- 防止多人同时编辑同一个工作流
- 避免内容冲突和数据丢失

**锁定规则**：
- 用户打开工作流编辑页面时自动锁定
- 锁定时记录locked_by（用户ID）和locked_at（锁定时间）
- 其他用户无法编辑已锁定的工作流

**解锁规则**：
- 用户关闭编辑页面时自动解锁
- 锁定超时自动解锁（如30分钟无操作）
- 锁定人可以主动解锁
- 管理员可以强制解锁

---

## 架构设计

### DDD四层架构

**1. 领域层 (Domain Layer)**
- `Workflow` - 工作流领域实体
- `WorkflowVersion` - 工作流版本领域实体
- `WorkflowRepository` - 工作流仓储接口
- `WorkflowVersionRepository` - 版本仓储接口

**2. 基础设施层 (Infrastructure Layer)**
- `WorkflowPO` - 工作流持久化对象
- `WorkflowVersionPO` - 版本持久化对象
- `WorkflowMapper` - MyBatis-Plus Mapper
- `WorkflowVersionMapper` - 版本Mapper
- `WorkflowConverter` - PO ↔ Entity 转换器
- `WorkflowVersionConverter` - 版本转换器
- `WorkflowRepositoryImpl` - 仓储实现
- `WorkflowVersionRepositoryImpl` - 版本仓储实现

**3. 应用层 (Application Layer)**
- `WorkflowDTO` - 工作流信息DTO
- `WorkflowVersionDTO` - 版本信息DTO
- `CreateWorkflowRequest` - 创建工作流请求DTO
- `UpdateWorkflowRequest` - 更新工作流请求DTO
- `SaveWorkflowContentRequest` - 保存内容请求DTO
- `WorkflowDTOConverter` - Entity ↔ DTO 转换器
- `WorkflowService` - 工作流应用服务接口
- `WorkflowServiceImpl` - 工作流应用服务实现
- `WorkflowVersionService` - 版本应用服务接口
- `WorkflowVersionServiceImpl` - 版本应用服务实现

**4. 接口层 (Interfaces Layer)**
- `WorkflowController` - 工作流REST API控制器
- `WorkflowVersionController` - 版本REST API控制器

---

## 核心业务方法

### Workflow 实体方法

**内容管理方法**：
- `saveContent(content)` - 保存工作流内容并计算哈希
- `getContent()` - 获取当前激活内容
- `calculateContentHash(content)` - 计算内容SHA-256哈希

**锁定控制方法**：
- `lock(userId)` - 锁定工作流
- `unlock()` - 解锁工作流
- `isLockedBy(userId)` - 判断是否被指定用户锁定
- `canEdit(userId)` - 判断用户是否可以编辑

### WorkflowVersion 实体方法

**版本创建方法**：
- `createVersion(workflowId, content, changeSummary, sessionId, userId)` - 创建新版本
- `calculateContentHash(content)` - 计算内容哈希

**版本查询方法**：
- `isSameContent(otherVersion)` - 判断内容是否相同

---

**最后更新**: 2026-01-16
