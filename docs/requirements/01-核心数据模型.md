# 核心数据模型

## 通用字段说明
- `create_time`: 创建时间，自动设置
- `create_by`: 创建人ID，可为 NULL
- `update_time`: 更新时间，自动更新
- `update_by`: 更新人ID，可为 NULL
- `is_deleted`: 逻辑删除，0=未删除，非0=删除时间戳

## 1. 用户模块

### user (用户表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| password | VARCHAR(255) | 密码(BCrypt) | NOT NULL |
| display_name | VARCHAR(100) | 显示名称 | |
| email | VARCHAR(100) | 邮箱 | UNIQUE |
| avatar_url | VARCHAR(500) | 头像URL | |
| role | VARCHAR(20) | 角色 | NOT NULL, DEFAULT 'USER' |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |

**索引**: `idx_username`, `idx_email`
**枚举**: role(`ADMIN`, `USER`), status(`ACTIVE`, `DISABLED`)

### user_permission (用户权限表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| permission_code | VARCHAR(100) | 权限码 | NOT NULL |
| resource_type | VARCHAR(50) | 资源类型 | NOT NULL |
| resource_id | BIGINT | 资源ID | NULL |

**索引**: `idx_user_id`, `idx_permission_code`
**枚举**: resource_type(`WORKFLOW`, `SERVICE`, `SESSION`, `SYSTEM`)

### login_log (登录日志表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| user_id | BIGINT | 用户ID | FK, NULL |
| username | VARCHAR(50) | 用户名 | NOT NULL |
| login_time | TIMESTAMP | 登录时间 | NOT NULL |
| login_ip | VARCHAR(50) | 登录IP | NOT NULL |
| login_status | VARCHAR(20) | 登录状态 | NOT NULL |
| failure_reason | VARCHAR(200) | 失败原因 | NULL |

**索引**: `idx_user_id`, `idx_login_time`
**枚举**: login_status(`SUCCESS`, `FAILURE`, `LOCKED`)

### token_blacklist (Token黑名单表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| token | VARCHAR(500) | Token值 | UNIQUE, NOT NULL |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| expire_time | TIMESTAMP | 过期时间 | NOT NULL |

**索引**: `idx_token`, `idx_expire_time`

## 2. 服务模块

### comfyui_service (ComfyUI服务表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| name | VARCHAR(100) | 服务名称 | NOT NULL |
| url | VARCHAR(500) | 服务URL | NOT NULL |
| description | TEXT | 描述 | |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'OFFLINE' |
| last_check_time | TIMESTAMP | 最后检测时间 | |

**索引**: `idx_status`
**枚举**: status(`ONLINE`, `OFFLINE`, `ERROR`)

## 3. 工作流模块

### workflow (工作流表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| service_id | BIGINT | 服务ID | FK, NOT NULL |
| name | VARCHAR(200) | 工作流名称 | NOT NULL |
| description | TEXT | 描述 | |
| workflow_data | JSON | 工作流JSON数据 | NOT NULL |
| is_favorite | TINYINT | 是否收藏 | DEFAULT 0 |
| last_used_at | TIMESTAMP | 最后使用时间 | |

**索引**: `idx_user_id`, `idx_service_id`, `idx_last_used_at`

### workflow_version (工作流版本表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| workflow_id | BIGINT | 工作流ID | FK, NOT NULL |
| session_id | BIGINT | 会话ID | FK, NULL |
| version_number | INT | 版本号 | NOT NULL |
| workflow_data | JSON | 工作流快照 | NOT NULL |
| change_summary | TEXT | 变更摘要 | |

**索引**: `idx_workflow_id`, `idx_session_id`

## 4. 会话模块

### chat_session (会话表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| workflow_id | BIGINT | 工作流ID | FK, NOT NULL |
| title | VARCHAR(200) | 会话标题 | NOT NULL |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |
| last_message_summary | TEXT | 最后消息摘要 | |

**索引**: `idx_user_id`, `idx_workflow_id`, `idx_status`
**枚举**: status(`ACTIVE`, `COMPLETED`, `ARCHIVED`)

### chat_message (消息表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| session_id | BIGINT | 会话ID | FK, NOT NULL |
| role | VARCHAR(20) | 角色 | NOT NULL |
| content | TEXT | 消息内容 | NOT NULL |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |

**索引**: `idx_session_id`, `idx_create_time`
**枚举**: role(`USER`, `ASSISTANT`, `SYSTEM`)

## 5. Agent模块

### agent_config (Agent配置表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| name | VARCHAR(100) | Agent名称 | NOT NULL |
| type | VARCHAR(50) | Agent类型 | NOT NULL |
| description | TEXT | 描述 | |
| model_id | BIGINT | 关联模型ID | FK, NOT NULL |
| system_prompt | TEXT | 系统提示词 | NOT NULL |
| temperature | DECIMAL(3,2) | 温度参数 | DEFAULT 0.7 |
| max_tokens | INT | 最大Token数 | DEFAULT 4096 |
| tools_config | JSON | 工具配置 | |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |

**索引**: `idx_type`, `idx_status`, `idx_model_id`
**枚举**: type(`WORKFLOW_EDITOR`, `WORKFLOW_ANALYZER`, `GENERAL_ASSISTANT`), status(`ACTIVE`, `INACTIVE`, `MAINTENANCE`)

### agent_execution (Agent执行记录表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| agent_id | BIGINT | Agent ID | FK, NOT NULL |
| session_id | BIGINT | 会话ID | FK, NOT NULL |
| message_id | BIGINT | 消息ID | FK, NOT NULL |
| execution_type | VARCHAR(50) | 执行类型 | NOT NULL |
| input_data | JSON | 输入数据 | NOT NULL |
| output_data | JSON | 输出数据 | |
| tools_called | JSON | 调用的工具 | |
| status | VARCHAR(20) | 执行状态 | NOT NULL |
| error_message | TEXT | 错误信息 | |
| start_time | TIMESTAMP | 开始时间 | NOT NULL |
| end_time | TIMESTAMP | 结束时间 | |
| duration_ms | INT | 执行时长(毫秒) | |
| token_usage | JSON | Token使用量 | |

**索引**: `idx_agent_id`, `idx_session_id`, `idx_message_id`, `idx_status`, `idx_start_time`
**枚举**: execution_type(`WORKFLOW_EDIT`, `WORKFLOW_ANALYZE`, `CHAT_RESPONSE`), status(`PENDING`, `RUNNING`, `SUCCESS`, `FAILED`, `TIMEOUT`)

## 6. AI模型模块

### model_provider (模型提供商表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| name | VARCHAR(100) | 提供商名称 | NOT NULL |
| code | VARCHAR(50) | 提供商代码 | UNIQUE, NOT NULL |
| base_url | VARCHAR(500) | API基础URL | NOT NULL |
| api_key | VARCHAR(500) | API密钥(加密) | NOT NULL |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |
| rate_limit | INT | 速率限制(次/分钟) | DEFAULT 60 |
| timeout_ms | INT | 超时时间(毫秒) | DEFAULT 30000 |
| retry_times | INT | 重试次数 | DEFAULT 3 |

**索引**: `idx_code`, `idx_status`
**枚举**: code(`OPENAI`, `ANTHROPIC`, `AZURE_OPENAI`, `ZHIPU`, `QWEN`, `DEEPSEEK`), status(`ACTIVE`, `INACTIVE`, `ERROR`)

### ai_model (AI模型表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| provider_id | BIGINT | 提供商ID | FK, NOT NULL |
| name | VARCHAR(100) | 模型名称 | NOT NULL |
| model_code | VARCHAR(100) | 模型代码 | NOT NULL |
| model_type | VARCHAR(50) | 模型类型 | NOT NULL |
| description | TEXT | 描述 | |
| max_tokens | INT | 最大Token数 | NOT NULL |
| support_stream | TINYINT | 是否支持流式 | DEFAULT 1 |
| support_tools | TINYINT | 是否支持工具调用 | DEFAULT 0 |
| input_price | DECIMAL(10,6) | 输入价格(元/1K tokens) | DEFAULT 0 |
| output_price | DECIMAL(10,6) | 输出价格(元/1K tokens) | DEFAULT 0 |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |

**索引**: `idx_provider_id`, `idx_model_type`, `idx_status`
**枚举**: model_type(`LLM`, `EMBEDDING`, `RERANK`), status(`ACTIVE`, `INACTIVE`, `DEPRECATED`)

### model_invocation (模型调用记录表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| model_id | BIGINT | 模型ID | FK, NOT NULL |
| agent_execution_id | BIGINT | Agent执行ID | FK, NULL |
| request_data | JSON | 请求数据 | NOT NULL |
| response_data | JSON | 响应数据 | |
| status | VARCHAR(20) | 调用状态 | NOT NULL |
| error_message | TEXT | 错误信息 | |
| start_time | TIMESTAMP | 开始时间 | NOT NULL |
| end_time | TIMESTAMP | 结束时间 | |
| duration_ms | INT | 执行时长(毫秒) | |
| input_tokens | INT | 输入Token数 | |
| output_tokens | INT | 输出Token数 | |
| total_cost | DECIMAL(10,6) | 总费用(元) | |

**索引**: `idx_model_id`, `idx_agent_execution_id`, `idx_status`, `idx_start_time`
**枚举**: status(`SUCCESS`, `FAILED`, `TIMEOUT`, `RATE_LIMITED`)

## 7. 资源模块

### file_record (文件记录表)
| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK |
| file_name | VARCHAR(255) | 文件名 | NOT NULL |
| file_path | VARCHAR(500) | 文件路径 | NOT NULL |
| file_size | BIGINT | 文件大小(字节) | NOT NULL |
| file_type | VARCHAR(50) | 文件类型 | NOT NULL |
| mime_type | VARCHAR(100) | MIME类型 | NOT NULL |
| storage_type | VARCHAR(20) | 存储类型 | NOT NULL |
| business_type | VARCHAR(50) | 业务类型 | NOT NULL |
| business_id | BIGINT | 业务ID | NULL |
| user_id | BIGINT | 上传用户ID | FK, NOT NULL |
| access_url | VARCHAR(500) | 访问URL | |
| is_public | TINYINT | 是否公开 | DEFAULT 0 |
| expire_time | TIMESTAMP | 过期时间 | |

**索引**: `idx_user_id`, `idx_business`, `idx_expire_time`, `idx_create_time`
**枚举**: storage_type(`LOCAL`, `OSS`, `S3`), business_type(`AVATAR`, `WORKFLOW_EXPORT`, `WORKFLOW_IMPORT`, `TEMP_FILE`), file_type(`IMAGE`, `JSON`, `ZIP`, `OTHER`)

## 实体关系图

```
# 核心业务关系
user (1) ----< (N) workflow
user (1) ----< (N) chat_session
user (1) ----< (N) file_record
comfyui_service (1) ----< (N) workflow
workflow (1) ----< (N) chat_session
workflow (1) ----< (N) workflow_version
chat_session (1) ----< (N) chat_message
chat_session (1) ----< (N) workflow_version
chat_session (1) ----< (N) agent_execution

# 认证授权关系
user (1) ----< (N) user_permission
user (1) ----< (N) login_log
user (1) ----< (N) token_blacklist

# Agent 和模型关系
ai_model (1) ----< (N) agent_config
agent_config (1) ----< (N) agent_execution
chat_message (1) ----< (N) agent_execution
ai_model (1) ----< (N) model_invocation
agent_execution (1) ----< (N) model_invocation

# 模型提供商关系
model_provider (1) ----< (N) ai_model
```
