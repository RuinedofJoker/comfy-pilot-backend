# 技术规范

## 架构规范

### DDD 四层架构
```
org.joker.comfypilot.{module}
├── interfaces/          # 接口层（用户接口层）
│   ├── controller/      # REST API 控制器
│   └── converter/       # DTO 转换器（如果其他层也需要converter一样的在对应层的位置定义converter包）
├── application/         # 应用层
│   ├── service/         # 应用服务
│   └── dto/            # 数据传输对象
├── domain/             # 领域层
│   ├── entity/         # 领域实体
│   └── repository/     # 仓储接口
└── infrastructure/     # 基础设施层
    └── persistence/    # 持久化实现
        ├── mapper/     # MyBatis Mapper 接口
        └── po/         # 持久化对象
```

### 包命名规范
```
com.comfypilot.{module}
  ├── domain
  ├── infrastructure
  ├── application
  └── interface
```

### 模块划分规范

#### 业务核心模块
- **user**: 用户信息管理
- **auth**: 登录认证、Token管理、密码重置
- **permission**: 角色管理、权限控制、访问校验
- **cfsvr**: ComfyUI服务配置、连接测试、状态查询
- **workflow**: 工作流CRUD、版本管理、快照机制、锁定控制
- **session**: AI对话、消息管理、WebSocket通信、工作流同步
- **agent**: Agent配置、调度、执行
- **model**: AI模型提供商、模型配置、接口调用
- **resource**: 文件上传、存储管理

#### 支撑服务模块
- **notification**: 邮件发送、模板管理、异步队列
- **monitor**: 服务健康检查、状态管理、统计数据
- **audit**: 操作记录、安全审计、日志查询

### 模块依赖关系

#### 核心依赖链
```
用户层: user → auth → permission
服务层: cfsvr → monitor
工作流层: workflow → session → agent → model
资源层: resource (独立)
```

#### 关键依赖说明
- **auth** → notification (密码重置邮件)
- **permission** → auth (获取用户角色)
- **cfsvr** → monitor (获取服务状态)
- **workflow** → session (快照关联)
- **session** → agent (AI对话处理)
- **agent** → model (模型调用)
- **所有模块** → audit (操作记录)

## 代码规范

### 实体类规范
- 使用 Lombok 注解
- 继承 BaseEntity (包含通用字段)
- 使用 @TableName 指定表名
- 使用 @TableField 配置字段映射

### 仓储接口规范
- 接口名: {Entity}Repository
- 实现类名: {Entity}RepositoryImpl
- 继承 BaseMapper<T>

### 服务类规范
- 接口名: {Module}Service
- 实现类名: {Module}ServiceImpl
- 使用 @Service 注解
- 使用 @Transactional 管理事务

### 控制器规范
- 类名: {Module}Controller
- 使用 @RestController 注解
- 使用 @RequestMapping 定义路径
- 统一返回 Result<T> 类型

## 数据库规范

### 表命名规范
- 小写字母+下划线
- 模块前缀: {module}_
- 示例: user, workflow, chat_session

### 字段命名规范
- 小写字母+下划线
- 主键: id (BIGINT)
- 外键: {table}_id
- 时间字段: {action}_time
- 布尔字段: is_{property}

### 通用字段
- create_time: 创建时间
- create_by: 创建人ID
- update_time: 更新时间
- update_by: 更新人ID
- is_deleted: 逻辑删除标记

### 索引规范
- 主键索引: pk_{table}
- 普通索引: idx_{column}
- 唯一索引: uk_{column}
- 外键索引: fk_{table}_{ref_table}

## API 规范

### RESTful 规范
- GET: 查询资源
- POST: 创建资源
- PUT: 更新资源
- DELETE: 删除资源

### URL 规范
- Base URL: /api/v1
- 资源路径: /api/v1/{resources}
- 资源ID: /api/v1/{resources}/{id}
- 子资源: /api/v1/{resources}/{id}/{sub-resources}

### 请求规范
- Content-Type: application/json
- 认证: Authorization: Bearer {token}
- 分页参数: page, size
- 排序参数: sortBy, sortOrder

### 响应规范
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

## 配置规范

### 配置文件
- application.yml: 主配置文件
- application-dev.yml: 开发环境
- application-prod.yml: 生产环境

### 配置项规范
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/comfypilot
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT}
```

### 敏感信息
- 使用环境变量
- 不提交到版本控制
- 使用配置中心管理

## 安全规范

### 认证规范
- JWT Token 认证
- Token 有效期: 24小时
- 支持 Token 刷新
- 登出后加入黑名单

### 权限规范
- 基于角色的权限控制(RBAC)
- 使用 @PreAuthorize 注解
- 权限码格式: {module}:{action}

### 密码规范
- BCrypt 加密
- 最小长度: 8位
- 复杂度: 字母+数字

### 接口安全
- HTTPS 传输
- CORS 跨域配置
- XSS 防护
- CSRF 防护

## 日志规范

### 日志级别
- ERROR: 错误信息
- WARN: 警告信息
- INFO: 重要业务信息
- DEBUG: 调试信息

### 日志内容
- 请求日志: 记录请求参数
- 响应日志: 记录响应结果
- 异常日志: 记录异常堆栈
- 业务日志: 记录关键业务操作

### 日志格式
```
[时间] [级别] [类名] - 日志内容
```

## 测试规范

### 单元测试
- 使用 JUnit 5
- 测试覆盖率 > 80%
- 测试类命名: {Class}Test
- 测试方法命名: test{Method}_{Scenario}

### 集成测试
- 使用 @SpringBootTest
- 测试数据库使用 H2
- 测试后清理数据

## 异常处理规范

### 异常分类
- BusinessException: 业务异常
- SystemException: 系统异常
- ValidationException: 参数验证异常

### 全局异常处理
- 使用 @ControllerAdvice
- 统一异常响应格式
- 记录异常日志

