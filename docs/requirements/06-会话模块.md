# 会话模块设计

## 模块职责
- AI 对话会话管理
- 消息收发处理
- WebSocket 实时通信

## 核心组件

### Domain 层
- **ChatSession**: 会话实体
- **ChatMessage**: 消息实体
- **SessionRepository**: 会话仓储接口

### Infrastructure 层
- **SessionRepositoryImpl**: 会话仓储实现
- **SessionMapper**: MyBatis-Plus Mapper
- **MessageMapper**: 消息 Mapper

### Application 层
- **SessionService**: 会话服务
  - 会话 CRUD
  - 会话列表查询
  - 会话状态管理
- **MessageService**: 消息服务
  - 消息发送
  - 消息历史查询
  - 消息摘要生成

### Interface 层
- **SessionController**: 会话管理接口
- **ChatWebSocketHandler**: WebSocket 处理器

## 核心流程

### 消息发送流程
1. 接收用户消息
2. 保存用户消息
3. 调用 Agent 处理
4. 保存 Agent 响应
5. 通过 WebSocket 推送

### WebSocket 连接流程
1. 验证 JWT Token
2. 建立 WebSocket 连接
3. 订阅会话消息
4. 处理消息收发

## 业务规则
- 会话删除时级联删除消息
- 消息按时间倒序排列
- 最后消息摘要自动更新
