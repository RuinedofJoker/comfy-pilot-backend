# 资源模块设计

## 模块职责
- 文件上传管理
- 文件存储策略
- 文件访问控制
- 文件清理调度

## 核心组件

### Domain 层
- **FileRecord**: 文件记录实体
- **FileRepository**: 文件仓储接口

### Infrastructure 层
- **FileRepositoryImpl**: 文件仓储实现
- **FileMapper**: MyBatis-Plus Mapper
- **StorageProvider**: 存储提供者接口
  - LocalStorageProvider (本地存储)
  - OSSStorageProvider (阿里云OSS)
  - S3StorageProvider (AWS S3)

### Application 层
- **FileStorageService**: 文件存储服务
  - 文件上传
  - 文件下载
  - 文件删除
  - 存储策略选择
- **FileValidator**: 文件验证器
  - 文件类型验证
  - 文件大小验证
  - 安全检查
- **FileCleanupScheduler**: 清理调度器
  - 定期清理过期文件
  - 清理临时文件

### Interface 层
- **FileController**: 文件管理接口

## 存储策略

### 本地存储 (LOCAL)
- 路径: `/data/files/{business_type}/{date}/{uuid}.{ext}`
- 适用: 开发环境、小规模部署

### 对象存储 (OSS/S3)
- 路径: `{bucket}/{business_type}/{date}/{uuid}.{ext}`
- 适用: 生产环境、大规模部署

### 策略选择
- 头像: 优先OSS/S3 (需CDN加速)
- 工作流导出: 本地存储 (临时文件)
- 工作流导入: 本地存储 (处理后删除)

## 文件验证规则

### 头像上传
- 类型: JPG、PNG、GIF
- 大小: 最大2MB
- 自动压缩: 超过500KB

### 工作流文件
- 类型: JSON
- 大小: 最大10MB
- 格式验证: 有效JSON

## 安全策略

### 访问控制
- 私有文件: 仅所有者可访问
- 公开文件: 所有人可访问
- 临时链接: 带签名和过期时间

### 文件隔离
- 按用户隔离存储路径
- 文件名UUID化
- 访问日志记录

## 清理策略
- 临时文件: 7天后删除
- 工作流导出: 30天后删除
- 过期文件: 到期立即删除
- 执行时间: 每天凌晨2:00
