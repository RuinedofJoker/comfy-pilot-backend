# AI模型模块设计

## 模块职责
- 模型提供商管理
- AI模型配置管理
- 模型调用统一接口
- 调用记录与费用统计

## 核心组件

### Domain 层
- **ModelProvider**: 模型提供商实体
- **AIModel**: AI模型实体
- **ModelInvocation**: 模型调用记录实体
- **ModelRepository**: 模型仓储接口

### Infrastructure 层
- **ModelRepositoryImpl**: 模型仓储实现
- **ModelProviderAdapter**: 提供商适配器接口
  - OpenAIAdapter
  - AnthropicAdapter
  - ZhipuAdapter
  - QwenAdapter
  - DeepSeekAdapter
- **RateLimiter**: 速率限制器(Redis实现)
- **ModelCache**: 模型调用缓存

### Application 层
- **ModelService**: 模型服务
  - 模型配置CRUD
  - 模型选择策略
- **ModelProviderService**: 提供商服务
  - 提供商配置CRUD
  - 连接测试
- **ModelInvocationService**: 调用服务
  - 统一调用接口
  - 调用记录
  - 费用统计

### Interface 层
- **ModelController**: 模型管理接口
- **ModelProviderController**: 提供商管理接口

## 模型类型

### LLM (大语言模型)
- 对话生成
- 工具调用
- 流式输出

### EMBEDDING (向量化模型)
- 文本向量化
- 语义搜索

### RERANK (重排序模型)
- 相关性排序
- 搜索结果优化

## 核心流程

### 模型调用流程
1. 选择合适的模型
2. 检查速率限制
3. 检查调用缓存
4. 转换请求参数
5. 调用提供商API
6. 转换响应格式
7. 记录调用信息
8. 计算费用

### 提供商适配流程
1. 实现统一接口
2. 转换请求格式
3. 处理API调用
4. 转换响应格式
5. 统一错误处理

## 性能优化

### 速率限制
- 令牌桶算法
- Redis分布式限流
- 按提供商/模型分别限流

### 调用缓存
- 缓存Key: MD5(modelId + requestParams)
- 有效期: 1小时
- 仅缓存确定性调用(temperature=0)

### 异常处理
- 超时重试: 最多3次
- 指数退避策略
- 自动降级切换
