# 认证模块 - 数据模型

> 本文档定义认证模块相关的数据存储设计

## Redis数据结构

### 1. 用户Token信息 (user_token)

**存储说明**: 使用Redis存储用户的JWT Token信息，用于Token管理和黑名单控制

**Key设计**:
- Access Token: `auth:access_token:{token}` (String类型)
- Refresh Token: `auth:refresh_token:{token}` (String类型)
- 用户Token列表: `auth:user_tokens:{userId}` (Set类型，存储该用户的所有token)

**Value结构** (JSON格式):
```json
{
  "userId": 1,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tokenType": "ACCESS",
  "expiresAt": "2024-01-16T10:30:00Z",
  "isRevoked": false,
  "revokedAt": null,
  "createTime": "2024-01-15T10:30:00Z"
}
```

**TTL设置**:
- Access Token: 24小时 (86400秒)
- Refresh Token: 7天 (604800秒)

**字段说明**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| userId | Long | 用户ID |
| token | String | JWT Token完整字符串 |
| tokenType | String | Token类型：ACCESS-访问令牌, REFRESH-刷新令牌 |
| expiresAt | String | 过期时间(ISO 8601格式) |
| isRevoked | Boolean | 是否已撤销（黑名单标记） |
| revokedAt | String | 撤销时间(ISO 8601格式) |
| createTime | String | 创建时间(ISO 8601格式) |

**操作说明**:
- 登录时：创建access_token和refresh_token两个key，并将token添加到用户token列表
- 登出时：将isRevoked设置为true，并更新revokedAt时间
- Token刷新：验证refresh_token，创建新的access_token
- 清理用户所有Token：通过user_tokens集合获取所有token并逐个删除

### 2. 密码重置令牌 (password_reset_token)

**存储说明**: 使用Redis存储密码重置请求的临时令牌

**Key设计**:
- 重置令牌: `auth:reset_token:{token}` (String类型)
- 用户重置令牌: `auth:user_reset:{userId}` (String类型，存储最新的重置token)

**Value结构** (JSON格式):
```json
{
  "userId": 1,
  "token": "550e8400-e29b-41d4-a716-446655440000",
  "expiresAt": "2024-01-15T10:45:00Z",
  "isUsed": false,
  "usedAt": null,
  "createTime": "2024-01-15T10:30:00Z"
}
```

**TTL设置**:
- 重置令牌: 15分钟 (900秒)

**字段说明**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| userId | Long | 用户ID |
| token | String | 重置令牌（UUID格式） |
| expiresAt | String | 过期时间(ISO 8601格式) |
| isUsed | Boolean | 是否已使用 |
| usedAt | String | 使用时间(ISO 8601格式) |
| createTime | String | 创建时间(ISO 8601格式) |

**操作说明**:
- 请求重置：生成UUID token，存储到Redis，发送邮件
- 验证令牌：检查token是否存在、是否过期、是否已使用
- 重置密码：验证通过后，将isUsed设置为true，更新usedAt时间
- 自动过期：Redis TTL到期后自动删除

### 3. 用户登录会话信息 (user_session)

**存储说明**: 存储用户登录后的会话信息，用于快速获取用户上下文

**Key设计**:
- 用户会话: `auth:session:{userId}` (Hash类型)

**Hash字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| userId | String | 用户ID |
| email | String | 用户邮箱 |
| username | String | 用户名 |
| roles | String | 用户角色列表(JSON数组字符串) |
| permissions | String | 用户权限列表(JSON数组字符串) |
| lastAccessTime | String | 最后访问时间 |

**TTL设置**:
- 用户会话: 24小时 (86400秒)，每次访问时刷新

**操作说明**:
- 登录时：创建用户会话信息
- 请求拦截器：从JWT获取userId，从Redis获取会话信息
- 权限变更：更新roles和permissions字段
- 登出时：删除会话信息

## 数据流程

### 登录流程
1. 验证用户名密码
2. 生成access_token和refresh_token
3. 将token信息存储到Redis（设置TTL）
4. 创建用户会话信息
5. 返回token给前端

### Token验证流程
1. 从请求头获取access_token
2. 从Redis查询token信息（key: `auth:access_token:{token}`）
3. 检查token是否存在、是否过期、是否被撤销
4. 从用户会话获取用户信息和权限
5. 放入请求上下文(定义一个ThreadLocal)供后续使用

### 登出流程
1. 从请求头获取access_token
2. 将token标记为已撤销（isRevoked=true）
3. 删除用户会话信息
4. 可选：删除该用户的所有token

### 密码重置流程
1. 用户请求重置密码
2. 生成UUID token，存储到Redis（TTL 15分钟）
3. 发送重置邮件
4. 用户点击链接，验证token
5. 重置密码后，标记token为已使用
6. 撤销该用户所有现有token
