# 认证模块 - 模块设计

> 本模块负责用户认证、Token管理、密码重置

## 模块功能

### 核心功能
- 用户注册：邮箱+密码注册新账户
- 用户登录：邮箱+密码登录，返回JWT Token
- 用户登录时的token等临时信息全部放到redis里，并编写拦截器来自动认证请求
- 用户登出：撤销当前redis里的Token和用户数据
- Token刷新：使用刷新令牌获取新的访问令牌
- 密码重置请求：发送密码重置邮件
- 密码重置确认：使用令牌重置密码

### 依赖模块
- 通知模块（密码重置邮件）
- 用户模块（用户信息查询）

## 业务逻辑

### 1. 用户注册
- 验证邮箱格式和唯一性
- 验证密码强度（最小8位，包含字母和数字）
- 使用BCrypt加密密码
- 创建用户记录，状态为ACTIVE
- 返回用户ID和邮箱

### 2. 用户登录
- 验证邮箱和密码
- 检查用户状态（ACTIVE才能登录）
- 生成JWT访问令牌（有效期24小时）
- 生成刷新令牌（有效期7天）
- 将Token信息存储到Redis（key: `auth:access_token:{token}` 和 `auth:refresh_token:{token}`）
- 创建用户会话信息到Redis（key: `auth:session:{userId}`）
- 更新用户最后登录时间和IP到数据库
- 返回Token和用户信息

### 3. 用户登出
- 验证当前Token有效性
- 从Redis更新Token信息，将isRevoked标记为true
- 删除用户会话信息（key: `auth:session:{userId}`）
- 可选：清理该用户的所有Token

### 4. Token刷新
- 验证刷新令牌有效性
- 从Redis检查刷新令牌是否已撤销（key: `auth:refresh_token:{token}`）
- 生成新的访问令牌
- 将新Token存储到Redis（key: `auth:access_token:{token}`）
- 返回新的访问令牌

### 5. 密码重置请求
- 验证邮箱是否存在
- 生成UUID重置令牌
- 设置过期时间（15分钟）
- 存储到Redis（key: `auth:reset_token:{token}`，TTL 900秒）
- 调用通知模块发送重置邮件

### 6. 密码重置确认
- 从Redis验证重置令牌有效性（key: `auth:reset_token:{token}`）
- 检查令牌是否过期或已使用
- 验证新密码强度
- 使用BCrypt加密新密码
- 更新用户密码到数据库
- 在Redis中标记令牌为已使用
- 撤销该用户所有现有Token（清理Redis中的所有相关token）
