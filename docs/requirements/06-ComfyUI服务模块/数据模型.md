# ComfyUI服务模块 - 数据模型

> 本文档定义ComfyUI服务模块相关的数据表设计

## 数据表

### comfyui_server - ComfyUI服务表

**表名**: `comfyui_server`

**表说明**: 存储ComfyUI服务的配置信息，支持手动创建和代码注册两种方式

#### 字段定义

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY | - | 主键ID（雪花算法） |
| server_key | VARCHAR(100) | NOT NULL, UNIQUE | - | 服务唯一标识符 |
| server_name | VARCHAR(100) | NOT NULL | - | 服务名称 |
| description | VARCHAR(500) | NULL | - | 服务描述 |
| base_url | VARCHAR(255) | NOT NULL | - | ComfyUI服务地址 |
| auth_mode | VARCHAR(20) | NULL | NULL | 认证模式（NULL/BASIC_AUTH/OAUTH2等） |
| api_key | VARCHAR(255) | NULL | - | API密钥（预留字段） |
| timeout_seconds | INT | NOT NULL | 30 | 请求超时时间（秒） |
| max_retries | INT | NOT NULL | 3 | 最大重试次数 |
| source_type | VARCHAR(20) | NOT NULL | - | 注册来源（MANUAL/CODE_BASED） |
| is_enabled | BOOLEAN | NOT NULL | TRUE | 是否启用 |
| last_health_check_time | TIMESTAMP | NULL | - | 最后健康检查时间 |
| health_status | VARCHAR(20) | NULL | - | 健康状态（HEALTHY/UNHEALTHY/UNKNOWN） |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | NOT NULL | - | 创建人ID |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |
| update_by | BIGINT | NOT NULL | - | 更新人ID |
| is_deleted | BIGINT | NOT NULL | 0 | 逻辑删除标记（0-未删除，非0-删除时的时间戳） |

#### 索引设计

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| PRIMARY | PRIMARY KEY | id | 主键索引 |
| uk_server_key | UNIQUE | server_key | 服务唯一标识符唯一索引 |
| idx_comfyui_server_source_type | INDEX | source_type | 注册来源索引 |
| idx_comfyui_server_is_enabled | INDEX | is_enabled | 启用状态索引 |
| idx_comfyui_server_health_status | INDEX | health_status | 健康状态索引 |

#### 字段说明

**server_key（服务唯一标识符）**:
- 全局唯一，用于定位ComfyUI服务
- 手动创建时：管理员可指定或自动生成UUID
- 代码注册时：开发者必须手动指定
- 创建后不可修改

**source_type（注册来源）**:
- `MANUAL` - 手动创建（管理员通过管理页面创建）
- `CODE_BASED` - 代码注册（开发者通过代码方式注册）

**auth_mode（认证模式）**:
- `NULL` - 无认证（当前默认）
- `BASIC_AUTH` - 基础认证（预留）
- `OAUTH2` - OAuth2认证（预留）
- `API_KEY` - API密钥认证（预留）

**health_status（健康状态）**:
- `HEALTHY` - 健康
- `UNHEALTHY` - 不健康
- `UNKNOWN` - 未知（默认状态）

#### 权限控制规则

根据 `source_type` 字段控制可编辑范围：

| 字段 | 手动创建(MANUAL) | 代码注册(CODE_BASED) |
|------|-----------------|---------------------|
| server_key | ❌ 创建后不可编辑 | ❌ 不可编辑 |
| server_name | ✅ 可编辑 | ✅ 可编辑 |
| description | ✅ 可编辑 | ✅ 可编辑 |
| base_url | ✅ 可编辑 | ❌ 不可编辑 |
| auth_mode | ✅ 可编辑 | ❌ 不可编辑 |
| api_key | ✅ 可编辑 | ❌ 不可编辑 |
| timeout_seconds | ✅ 可编辑 | ❌ 不可编辑 |
| max_retries | ✅ 可编辑 | ❌ 不可编辑 |
| is_enabled | ✅ 可编辑 | ❌ 不可编辑 |

**删除规则**:
- MANUAL类型：允许通过管理页面删除
- CODE_BASED类型：不允许通过管理页面删除

#### 数据库迁移脚本

**文件**: `src/main/resources/db/migration/V5__create_comfyui_server_table.sql`

**实现状态**: ✅ 已完成

---

**最后更新**: 2026-01-16
