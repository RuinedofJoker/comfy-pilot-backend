# ComfyUI服务模块 - 模块设计

> 本模块负责ComfyUI服务配置、REST客户端、健康检查、工具集成

## 模块概述

**模块名称**: ComfyUI服务模块 (cfsvr)

**包路径**: `org.joker.comfypilot.cfsvr`

**实现状态**: ✅ 核心功能已完成

---

## 模块功能

### 核心功能

#### 已完成功能 ✅

1. **服务配置管理（CRUD）**
   - ✅ 创建服务（手动）
   - ✅ 查询服务列表（支持过滤）
   - ✅ 查询服务详情（按ID/serverKey）
   - ✅ 更新服务信息
   - ✅ 删除服务
   - ✅ Redis 缓存集成（缓存双删）

2. **REST 客户端**
   - ✅ ComfyUI REST 客户端接口（7个核心接口）
   - ✅ WebClient 实现（Spring WebFlux）
   - ✅ Basic Auth 认证支持
   - ✅ 客户端工厂和缓存机制

3. **健康检查服务**
   - ✅ 定时健康检查（每5分钟）
   - ✅ 健康状态自动更新
   - ✅ 异常处理和日志记录

4. **工具集成**
   - ✅ LangChain4j 工具类
   - ✅ 5个工具方法自动注册
   - ✅ 基于 serverKey 的调用

---

## 业务逻辑

### 认证模式

**AuthMode 枚举**：

1. **NULL（无认证）**
   - 直接访问 ComfyUI 服务
   - 适用于内网环境

2. **BASIC_AUTH（Basic 认证）**
   - 通过 Nginx 反向代理添加认证
   - apiKey 格式：`username:password`
   - 适用于公网暴露场景

### 缓存策略

**Redis 缓存**：
- 缓存键：`comfyui:server:id:{id}` 和 `comfyui:server:key:{serverKey}`
- 过期时间：24 小时
- 缓存双删：更新/删除时先删缓存 → 操作数据库 → 延迟500ms再删缓存

**客户端缓存**：
- 使用 `ConcurrentHashMap` 缓存 WebClient 实例
- 按 serverId 缓存，线程安全
- 配置更新时自动失效

---

## 架构设计

### DDD四层架构

**1. 领域层 (Domain Layer)**
- `AuthMode` - 认证模式枚举（NULL、BASIC_AUTH）
- `HealthStatus` - 健康状态枚举
- `ComfyuiServer` - 领域实体（包含业务逻辑）
- `ComfyuiServerRepository` - 仓储接口

**2. 基础设施层 (Infrastructure Layer)**
- `ComfyuiServerPO` - 持久化对象
- `ComfyuiServerMapper` - MyBatis-Plus Mapper
- `ComfyuiServerConverter` - PO ↔ Entity 转换器
- `ComfyuiServerRepositoryImpl` - 仓储实现（含 Redis 缓存）
- `ComfyUIRestClient` - REST 客户端接口
- `ComfyUIRestClientImpl` - REST 客户端实现
- `ComfyUIClientFactory` - 客户端工厂（含缓存）
- DTO 类：`SystemStatsResponse`、`QueueStatusResponse`、`PromptRequest`、`PromptResponse`

---

**3. 应用层 (Application Layer)**
- `ComfyuiServerDTO` - 服务信息DTO
- `CreateServerRequest` - 创建服务请求DTO
- `UpdateServerRequest` - 更新服务请求DTO
- `ComfyuiServerDTOConverter` - Entity ↔ DTO 转换器
- `ComfyuiServerService` - 应用服务接口
- `ComfyuiServerServiceImpl` - 应用服务实现
- `ComfyuiServerHealthCheckService` - 健康检查服务接口
- `ComfyuiServerHealthCheckServiceImpl` - 健康检查实现
- `ComfyUIServerTool` - LangChain4j 工具类

**4. 接口层 (Interfaces Layer)**
- `ComfyuiServerController` - REST API控制器

---

### 依赖模块

**当前依赖**：
- Redis（缓存）
- Spring WebFlux（WebClient）
- LangChain4j（工具集成）

**被依赖**：
- Agent 模块（通过工具调用）
- 工作流模块（未来）

---

## 核心业务方法

### ComfyuiServer 实体方法

**业务操作方法**：
- `updateBasicInfo(serverName, description)` - 更新基本信息
- `updateConnectionConfig(baseUrl, authMode, apiKey, timeoutSeconds, maxRetries)` - 更新连接配置
- `setEnabled(enabled)` - 启用/禁用服务
- `updateHealthStatus(status)` - 更新健康状态
- `isHealthy()` - 判断服务是否健康

### ComfyUIRestClient 接口方法

**系统状态**：
- `getSystemStats()` - 获取系统状态
- `getQueueStatus()` - 获取队列状态

**工作流执行**：
- `submitPrompt(request)` - 提交工作流执行

**模型管理**：
- `getModelFolders()` - 获取模型文件夹列表
- `getModels(folder)` - 获取指定文件夹的模型列表

**历史记录**：
- `getHistory()` - 获取历史记录
- `getHistoryByPromptId(promptId)` - 获取特定任务历史

---

**最后更新**: 2026-01-18
