# ComfyUI服务模块 - 模块设计

> 本模块负责ComfyUI服务配置、连接测试、状态查询

## 模块概述

**模块名称**: ComfyUI服务模块 (cfsvr)

**包路径**: `org.joker.comfypilot.cfsvr`

**实现状态**: ✅ 手动创建功能已完成，⏳ 代码注册功能待实现

---

## 模块功能

### 核心功能

#### 已完成功能 ✅

1. **服务配置管理（CRUD）**
   - ✅ 创建服务（手动）
   - ✅ 查询服务列表（支持过滤）
   - ✅ 查询服务详情（按ID/serverKey）
   - ✅ 更新服务信息（权限控制）
   - ✅ 删除服务（权限控制）

#### 待实现功能 ⏳

2. **代码注册服务**
   - ⏳ 代码方式注册服务
   - ⏳ 幂等性处理
   - ⏳ 启动时自动注册

3. **服务连接测试**
   - ⏳ HTTP连接测试
   - ⏳ 超时和重试处理

4. **服务健康检查**
   - ⏳ 定时健康检查
   - ⏳ 健康状态更新

---

## 业务逻辑

### 服务注册来源

**两种注册方式**：

1. **手动创建（MANUAL）**
   - 管理员通过管理页面创建
   - serverKey可选（不填则自动生成UUID）
   - 所有字段可编辑
   - 允许删除

2. **代码注册（CODE_BASED）**
   - 开发者通过代码方式注册
   - serverKey必填
   - 仅基本信息可编辑（serverName、description）
   - 不允许通过管理页面删除

---

### 权限控制规则

**基于 source_type 的权限控制**：

| 操作 | MANUAL | CODE_BASED |
|------|--------|------------|
| 修改基本信息 | ✅ | ✅ |
| 修改连接配置 | ✅ | ❌ |
| 启用/禁用 | ✅ | ❌ |
| 删除服务 | ✅ | ❌ |

**实现方式**：
- 领域层验证：在 `ComfyuiServer` 实体的业务方法中校验
- 抛出 `BusinessException` 阻止非法操作

---

## 架构设计

### DDD四层架构

**1. 领域层 (Domain Layer)**
- `ServerSourceType` - 服务注册来源枚举
- `HealthStatus` - 健康状态枚举
- `ComfyuiServer` - 领域实体（包含业务逻辑）
- `ComfyuiServerRepository` - 仓储接口

**2. 基础设施层 (Infrastructure Layer)**
- `ComfyuiServerPO` - 持久化对象
- `ComfyuiServerMapper` - MyBatis-Plus Mapper
- `ComfyuiServerConverter` - PO ↔ Entity 转换器
- `ComfyuiServerRepositoryImpl` - 仓储实现

---

**3. 应用层 (Application Layer)**
- `ComfyuiServerDTO` - 服务信息DTO
- `CreateServerRequest` - 创建服务请求DTO
- `UpdateServerRequest` - 更新服务请求DTO
- `ComfyuiServerDTOConverter` - Entity ↔ DTO 转换器
- `ComfyuiServerService` - 应用服务接口
- `ComfyuiServerServiceImpl` - 应用服务实现

**4. 接口层 (Interfaces Layer)**
- `ComfyuiServerController` - REST API控制器

---

### 依赖模块

**当前依赖**：
- 无（独立模块）

**未来依赖**：
- 监控模块（获取服务状态）- 待实现

---

## 核心业务方法

### ComfyuiServer 实体方法

**权限控制方法**：
- `canModifyConnectionConfig()` - 判断是否允许修改连接配置

**业务操作方法**：
- `updateBasicInfo(serverName, description)` - 更新基本信息
- `updateConnectionConfig(...)` - 更新连接配置（含权限校验）
- `setEnabled(enabled)` - 启用/禁用服务（含权限校验）
- `updateHealthStatus(status)` - 更新健康状态

---

**最后更新**: 2026-01-16
