# 会话模块 - 数据模型

> 本文档定义会话模块相关的数据表设计

## 1. 数据表概览

会话模块包含 2 个核心数据表：

1. **chat_session** - 聊天会话表
2. **chat_message** - 聊天消息表

---

## 2. chat_session - 聊天会话表

### 2.1 表说明

存储用户与 Agent 的对话会话信息。

### 2.2 表结构

```sql
CREATE TABLE chat_session (
    id BIGSERIAL PRIMARY KEY,
    session_code VARCHAR(50) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    agent_id BIGINT NOT NULL,
    title VARCHAR(200),
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by BIGINT,
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    is_deleted BOOLEAN DEFAULT FALSE
);

COMMENT ON TABLE chat_session IS '聊天会话表';
COMMENT ON COLUMN chat_session.id IS '会话ID';
COMMENT ON COLUMN chat_session.session_code IS '会话编码（唯一）';
COMMENT ON COLUMN chat_session.user_id IS '用户ID';
COMMENT ON COLUMN chat_session.agent_id IS '关联的Agent ID';
COMMENT ON COLUMN chat_session.title IS '会话标题';
COMMENT ON COLUMN chat_session.status IS '会话状态：ACTIVE-活跃，ARCHIVED-已归档';
COMMENT ON COLUMN chat_session.create_time IS '创建时间';
COMMENT ON COLUMN chat_session.create_by IS '创建人ID';
COMMENT ON COLUMN chat_session.update_time IS '更新时间';
COMMENT ON COLUMN chat_session.update_by IS '更新人ID';
COMMENT ON COLUMN chat_session.is_deleted IS '逻辑删除标记';
```

### 2.3 字段说明

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | 自增 | 主键 |
| session_code | VARCHAR | 50 | 是 | - | 会话唯一编码 |
| user_id | BIGINT | - | 是 | - | 用户ID |
| agent_id | BIGINT | - | 是 | - | 关联的Agent ID |
| title | VARCHAR | 200 | 否 | - | 会话标题 |
| status | VARCHAR | 20 | 是 | ACTIVE | 会话状态 |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | - | 否 | - | 创建人ID |
| update_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| update_by | BIGINT | - | 否 | - | 更新人ID |
| is_deleted | BOOLEAN | - | 否 | FALSE | 逻辑删除标记 |

### 2.4 索引设计

```sql
-- 主键索引
CREATE UNIQUE INDEX pk_chat_session ON chat_session(id);

-- 唯一索引
CREATE UNIQUE INDEX uk_session_code ON chat_session(session_code);

-- 普通索引
CREATE INDEX idx_user_id ON chat_session(user_id);
CREATE INDEX idx_agent_id ON chat_session(agent_id);
CREATE INDEX idx_status ON chat_session(status);
CREATE INDEX idx_create_time ON chat_session(create_time);

-- 复合索引
CREATE INDEX idx_user_status ON chat_session(user_id, status);
```

### 2.5 枚举值

**status（会话状态）**：
- `ACTIVE` - 活跃
- `ARCHIVED` - 已归档

---

## 3. chat_message - 聊天消息表

### 3.1 表说明

存储会话中的所有消息，包括用户消息和 Agent 消息。

### 3.2 表结构

```sql
CREATE TABLE chat_message (
    id BIGSERIAL PRIMARY KEY,
    session_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    metadata JSONB,
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by BIGINT,
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    is_deleted BOOLEAN DEFAULT FALSE
);

COMMENT ON TABLE chat_message IS '聊天消息表';
COMMENT ON COLUMN chat_message.id IS '消息ID';
COMMENT ON COLUMN chat_message.session_id IS '所属会话ID';
COMMENT ON COLUMN chat_message.role IS '消息角色：USER-用户，ASSISTANT-助手';
COMMENT ON COLUMN chat_message.content IS '消息内容';
COMMENT ON COLUMN chat_message.metadata IS '元数据（JSON格式）';
COMMENT ON COLUMN chat_message.create_time IS '创建时间';
COMMENT ON COLUMN chat_message.create_by IS '创建人ID';
COMMENT ON COLUMN chat_message.update_time IS '更新时间';
COMMENT ON COLUMN chat_message.update_by IS '更新人ID';
COMMENT ON COLUMN chat_message.is_deleted IS '逻辑删除标记';
```

### 3.3 字段说明

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | 自增 | 主键 |
| session_id | BIGINT | - | 是 | - | 所属会话ID |
| role | VARCHAR | 20 | 是 | - | 消息角色 |
| content | TEXT | - | 是 | - | 消息内容 |
| metadata | JSONB | - | 否 | - | 元数据 |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | - | 否 | - | 创建人ID |
| update_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| update_by | BIGINT | - | 否 | - | 更新人ID |
| is_deleted | BOOLEAN | - | 否 | FALSE | 逻辑删除标记 |

### 3.4 索引设计

```sql
-- 主键索引
CREATE UNIQUE INDEX pk_chat_message ON chat_message(id);

-- 普通索引
CREATE INDEX idx_session_id ON chat_message(session_id);
CREATE INDEX idx_role ON chat_message(role);
CREATE INDEX idx_create_time ON chat_message(create_time);

-- 复合索引
CREATE INDEX idx_session_create ON chat_message(session_id, create_time);
CREATE INDEX idx_session_role ON chat_message(session_id, role);
```

### 3.5 枚举值

**role（消息角色）**：
- `USER` - 用户消息
- `ASSISTANT` - Agent 消息

### 3.6 metadata 字段说明

metadata 字段存储消息的元数据信息，采用 JSONB 格式。

**用户消息元数据示例**：
```json
{
  "clientInfo": {
    "userAgent": "Mozilla/5.0...",
    "ip": "192.168.1.1"
  }
}
```

**Agent 消息元数据示例**：
```json
{
  "model": "gpt-4",
  "inputTokens": 100,
  "outputTokens": 150,
  "totalTokens": 250,
  "executionTimeMs": 1200,
  "finishReason": "stop"
}
```

---

## 4. 表关系

### 4.1 ER 图

```
┌─────────────────┐
│   chat_session  │
│─────────────────│
│ id (PK)         │
│ session_code    │
│ user_id (FK)    │
│ agent_id (FK)   │
│ title           │
│ status          │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────┐
│  chat_message   │
│─────────────────│
│ id (PK)         │
│ session_id (FK) │
│ role            │
│ content         │
│ metadata        │
└─────────────────┘
```

### 4.2 外键关系

```sql
-- chat_session 外键
ALTER TABLE chat_session
    ADD CONSTRAINT fk_session_user
    FOREIGN KEY (user_id)
    REFERENCES "user"(id);

ALTER TABLE chat_session
    ADD CONSTRAINT fk_session_agent
    FOREIGN KEY (agent_id)
    REFERENCES agent_config(id);

-- chat_message 外键
ALTER TABLE chat_message
    ADD CONSTRAINT fk_message_session
    FOREIGN KEY (session_id)
    REFERENCES chat_session(id);
```

---

## 5. 数据示例

### 5.1 chat_session 示例数据

```sql
INSERT INTO chat_session (session_code, user_id, agent_id, title, status)
VALUES
    ('SESSION_20260117_001', 1, 1, '工作流编辑会话', 'ACTIVE'),
    ('SESSION_20260117_002', 1, 2, '简单对话会话', 'ACTIVE'),
    ('SESSION_20260116_001', 2, 1, '历史会话', 'ARCHIVED');
```

### 5.2 chat_message 示例数据

```sql
INSERT INTO chat_message (session_id, role, content, metadata)
VALUES
    (1, 'USER', '请帮我创建一个图像生成工作流', '{"clientInfo": {"ip": "192.168.1.1"}}'),
    (1, 'ASSISTANT', '好的，我来帮你创建一个图像生成工作流...',
     '{"model": "gpt-4", "inputTokens": 20, "outputTokens": 100, "executionTimeMs": 1500}'),
    (1, 'USER', '添加一个文本输入节点', '{"clientInfo": {"ip": "192.168.1.1"}}'),
    (1, 'ASSISTANT', '已添加文本输入节点...',
     '{"model": "gpt-4", "inputTokens": 15, "outputTokens": 50, "executionTimeMs": 800}');
```

---

## 6. 查询示例

### 6.1 查询用户的所有活跃会话

```sql
SELECT * FROM chat_session
WHERE user_id = 1
  AND status = 'ACTIVE'
  AND is_deleted = FALSE
ORDER BY update_time DESC;
```

### 6.2 查询会话的消息历史

```sql
SELECT * FROM chat_message
WHERE session_id = 1
  AND is_deleted = FALSE
ORDER BY create_time ASC;
```

### 6.3 查询会话的最后一条消息

```sql
SELECT * FROM chat_message
WHERE session_id = 1
  AND is_deleted = FALSE
ORDER BY create_time DESC
LIMIT 1;
```

### 6.4 统计会话的消息数量

```sql
SELECT
    session_id,
    COUNT(*) as message_count,
    SUM(CASE WHEN role = 'USER' THEN 1 ELSE 0 END) as user_message_count,
    SUM(CASE WHEN role = 'ASSISTANT' THEN 1 ELSE 0 END) as assistant_message_count
FROM chat_message
WHERE is_deleted = FALSE
GROUP BY session_id;
```

---

## 7. 性能优化建议

### 7.1 分区策略

对于消息量大的场景，可以考虑按时间分区：

```sql
-- 按月分区
CREATE TABLE chat_message (
    -- 字段定义...
) PARTITION BY RANGE (create_time);

CREATE TABLE chat_message_2026_01 PARTITION OF chat_message
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

CREATE TABLE chat_message_2026_02 PARTITION OF chat_message
    FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
```

### 7.2 索引优化

- 为高频查询字段创建索引
- 使用复合索引优化多条件查询
- 定期分析和重建索引

### 7.3 数据归档

- 定期归档历史会话
- 将归档数据迁移到历史表
- 保留最近 N 个月的活跃数据

---
