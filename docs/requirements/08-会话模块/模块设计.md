# 会话模块 - 模块设计

> 本模块负责AI对话、消息管理、WebSocket通信、工作流同步

## 1. 模块概述

### 1.1 模块定位
会话模块是用户与 AI Agent 交互的核心模块，负责管理对话会话、消息历史、实时通信。

### 1.2 核心职责
- 会话生命周期管理（创建、查询、更新、删除）
- 消息发送/接收和历史记录
- WebSocket 实时通信
- 会话-Agent 关联管理
- 会话-工作流版本关联

### 1.3 设计原则
- **会话隔离**：每个会话独立管理消息历史
- **实时响应**：WebSocket 实现实时消息推送
- **历史可追溯**：完整记录对话历史
- **Agent 可切换**：支持会话中切换 Agent
- **工作流关联**：会话可关联工作流版本

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                             │
│              WebSocket + REST API                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  会话模块 (Session)                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │  1. 会话管理层                                   │   │
│  │     - ChatSessionService                         │   │
│  │     - 会话 CRUD                                  │   │
│  │     - 会话-Agent 关联                            │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  2. 消息管理层                                   │   │
│  │     - ChatMessageService                         │   │
│  │     - 消息发送/接收                              │   │
│  │     - 消息历史查询                               │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  3. WebSocket 通信层                             │   │
│  │     - ChatWebSocketHandler                       │   │
│  │     - 连接管理                                   │   │
│  │     - 实时消息推送                               │   │
│  └─────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  Agent 模块                               │
│              AgentExecutor → Agent                       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 会话-Agent 交互流程（WebSocket 流式输出）

```
用户
  ↓ 1. 建立 WebSocket 连接
ChatWebSocketHandler
  ↓ 2. 创建 WebSocketSessionContext
  ↓ 3. 用户发送消息（START_SESSION/USER_MESSAGE）
ChatSessionService.sendMessageAsync()
  ↓ 4. 保存用户消息到 chat_message
  ↓ 5. 创建 WebSocketStreamCallback
  ↓ 6. 构建 AgentExecutionContext（包含 StreamCallback）
  ↓ 7. 调用 AgentExecutor.execute()
AgentExecutor
  ↓ 8. 检查中断标志
  ↓ 9. 执行 Agent（支持流式输出）
Agent
  ↓ 10. 通过 StreamCallback 实时推送
  ↓     - onThinking() → AGENT_THINKING
  ↓     - onStream(chunk) → AGENT_STREAM
  ↓     - onToolCall() → AGENT_TOOL_CALL
  ↓     - onRequestInput() → AGENT_REQUEST_INPUT
  ↓     - onComplete() → AGENT_COMPLETE
WebSocketStreamCallback
  ↓ 11. 将事件转换为 WebSocket 消息
  ↓ 12. 实时推送给用户
用户（实时接收流式输出）
  ↓ 13. 可随时发送 INTERRUPT 消息中断执行
ChatSessionService
  ↓ 14. 保存完整的 Agent 消息到 chat_message
```

---

## 3. 核心组件

### 3.1 ChatSession（会话实体）

**职责**：
- 表示一个对话会话
- 关联用户和 Agent
- 管理会话状态

**核心属性**：
- `sessionCode` - 会话唯一编码
- `userId` - 用户 ID
- `agentId` - 关联的 Agent ID
- `title` - 会话标题
- `status` - 会话状态（ACTIVE/ARCHIVED）

**领域行为**：
- `updateTitle()` - 更新会话标题
- `archive()` - 归档会话
- `activate()` - 激活会话
- `changeAgent()` - 切换 Agent

---

### 3.2 ChatMessage（消息实体）

**职责**：
- 表示一条对话消息
- 区分用户消息和 Agent 消息

**核心属性**：
- `sessionId` - 所属会话 ID
- `role` - 消息角色（USER/ASSISTANT）
- `content` - 消息内容
- `metadata` - 元数据（JSON 格式）

**元数据示例**：
```json
{
  "model": "gpt-4",
  "tokens": 150,
  "executionTimeMs": 1200
}
```

---

### 3.3 ChatSessionService（会话服务）

**职责**：
- 会话管理
- 消息异步发送（支持流式输出）
- 调用 Agent 执行
- WebSocket 流式回调管理

**核心方法**：
- `createSession(userId, agentId, title)` - 创建会话，返回 sessionCode
- `getSessionByCode(sessionCode)` - 根据会话编码获取会话详情
- `getSessionsByUserId(userId)` - 查询用户的会话列表
- `archiveSession(sessionCode)` - 归档会话
- `sendMessageAsync(sessionCode, content, wsContext, webSocketSession)` - 异步发送消息（支持流式输出和中断）
- `getMessageHistory(sessionCode)` - 获取消息历史

**新增特性**：
- 支持 WebSocket 流式输出
- 支持执行过程中断
- 异步执行 Agent，不阻塞 WebSocket 连接

---

### 3.4 ChatWebSocketHandler（WebSocket 处理器）

**职责**：
- WebSocket 连接管理
- 实时消息推送
- 心跳保活
- 消息类型路由

**核心方法**：
- `afterConnectionEstablished()` - 连接建立，创建 WebSocketSessionContext
- `handleTextMessage()` - 处理文本消息，根据消息类型路由
- `afterConnectionClosed()` - 连接关闭，清理上下文
- `sendMessage()` - 推送消息给客户端
- `handleStartSession()` - 处理开始会话消息
- `handleUserMessage()` - 处理用户消息
- `handleInterrupt()` - 处理中断消息
- `handlePing()` - 处理心跳消息

**支持的消息类型**：
- **客户端 → 服务端**：
  - `START_SESSION` - 开始会话
  - `USER_MESSAGE` - 用户消息
  - `INTERRUPT` - 中断执行
  - `PING` - 心跳
- **服务端 → 客户端**：
  - `SESSION_CREATED` - 会话已创建
  - `AGENT_THINKING` - Agent 思考中
  - `AGENT_STREAM` - Agent 流式输出
  - `AGENT_TOOL_CALL` - Agent 调用工具
  - `AGENT_REQUEST_INPUT` - Agent 请求输入
  - `AGENT_COMPLETE` - Agent 完成
  - `EXECUTION_INTERRUPTED` - 执行中断
  - `ERROR` - 错误
  - `PONG` - 心跳响应

---

### 3.5 WebSocketSessionContext（WebSocket 会话上下文）

**职责**：
- 管理单个 WebSocket 连接的执行状态
- 控制执行和中断标志
- 跟踪会话活跃时间

**核心属性**：
- `webSocketSession` - WebSocket 会话对象
- `sessionCode` - 聊天会话编码
- `userId` - 用户 ID
- `executing` - 是否正在执行（AtomicBoolean）
- `interrupted` - 中断标志（AtomicBoolean）
- `createTime` - 创建时间
- `lastActiveTime` - 最后活跃时间

**核心方法**：
- `canExecute()` - 检查是否可以执行
- `startExecution()` - 开始执行
- `completeExecution()` - 完成执行
- `requestInterrupt()` - 请求中断
- `isInterrupted()` - 检查是否被中断
- `updateActiveTime()` - 更新活跃时间

---

### 3.6 WebSocketStreamCallback（流式输出回调）

**职责**：
- 实现 StreamCallback 接口
- 将 Agent 执行事件转换为 WebSocket 消息
- 实时推送给客户端

**核心方法**：
- `onThinking()` - Agent 开始思考
- `onStream(chunk)` - Agent 流式输出内容
- `onToolCall(toolName, toolArgs)` - Agent 调用工具
- `onRequestInput(prompt)` - Agent 请求用户输入
- `onComplete(fullContent)` - Agent 执行完成
- `onError(error)` - 执行错误
- `isInterrupted()` - 检查是否被中断

---

### 3.7 WebSocketSessionManager（会话管理器）

**职责**：
- 管理所有活跃的 WebSocket 连接
- 提供会话上下文的增删改查
- 支持中断请求

**核心方法**：
- `addSession(sessionId, webSocketSession, userId)` - 添加会话
- `getContext(sessionId)` - 获取会话上下文
- `removeSession(sessionId)` - 移除会话
- `updateSessionCode(sessionId, sessionCode)` - 更新会话编码
- `requestInterrupt(sessionId)` - 请求中断执行

---

## 4. 业务逻辑

### 4.1 创建会话

**流程**：
1. 用户选择 Agent
2. 创建会话记录
3. 生成会话编码
4. 返回会话信息

**规则**：
- 会话编码唯一
- 必须关联有效的 Agent
- 初始状态为 ACTIVE

---

### 4.2 发送消息（WebSocket 流式输出）

**流程**：
1. 用户通过 WebSocket 发送 USER_MESSAGE
2. 检查会话是否可以执行（不在执行中且未中断）
3. 保存用户消息到数据库
4. 创建 WebSocketStreamCallback
5. 构建 AgentExecutionContext（包含 StreamCallback）
6. 异步调用 AgentExecutor.execute()
7. Agent 执行过程中通过 StreamCallback 实时推送：
   - onThinking() → 推送 AGENT_THINKING
   - onStream(chunk) → 推送 AGENT_STREAM
   - onToolCall() → 推送 AGENT_TOOL_CALL
   - onRequestInput() → 推送 AGENT_REQUEST_INPUT
   - onComplete() → 推送 AGENT_COMPLETE
8. 保存完整的 Agent 响应到数据库
9. 标记执行完成

**规则**：
- 消息内容不能为空
- 会话必须处于 ACTIVE 状态
- 同一 WebSocket 连接同时只能执行一个 Agent
- 用户可随时发送 INTERRUPT 消息中断执行
- 记录执行时间和 Token 使用量

**中断机制**：
1. 用户发送 INTERRUPT 消息
2. WebSocketSessionContext 设置中断标志
3. AgentExecutor 在执行前检查中断标志
4. Agent 执行过程中定期检查 isInterrupted()
5. 检测到中断后立即停止执行
6. 返回中断错误信息

---

### 4.3 消息历史查询

**流程**：
1. 根据会话 ID 查询消息
2. 按时间正序排列
3. 支持分页

**规则**：
- 只能查询自己的会话消息
- 支持按角色过滤（USER/ASSISTANT）

---

### 4.4 WebSocket 通信

**连接建立**：
1. 客户端发起 WebSocket 连接到 `/ws/chat`
2. 携带 Token 进行认证（TODO: 待集成认证模块）
3. 创建 WebSocketSessionContext
4. 保存到 WebSocketSessionManager

**开始会话**：
1. 客户端发送 START_SESSION 消息（包含 agentId 和 title）
2. 服务端创建聊天会话
3. 更新 WebSocketSessionContext 的 sessionCode
4. 返回 SESSION_CREATED 消息

**消息交互**：
1. 客户端发送 USER_MESSAGE（包含 sessionCode 和 content）
2. 服务端异步执行 Agent
3. 通过 WebSocketStreamCallback 实时推送执行过程
4. 客户端实时接收流式输出

**中断执行**：
1. 客户端发送 INTERRUPT 消息
2. 服务端设置中断标志
3. Agent 检测到中断后停止执行
4. 返回 EXECUTION_INTERRUPTED 消息

**心跳保活**：
1. 客户端定期发送 PING（建议 30 秒）
2. 服务端响应 PONG
3. 超时自动断开连接（TODO: 待实现超时检测）

**连接关闭**：
1. 客户端主动关闭或网络断开
2. 服务端清理 WebSocketSessionContext
3. 从 WebSocketSessionManager 移除

---

## 5. 依赖关系

### 5.1 依赖的模块
- **Agent 模块**：调用 AgentExecutor 执行 Agent
- **User 模块**：获取用户信息
- **Workflow 模块**：关联工作流版本（可选）

### 5.2 被依赖的模块
- 无（会话模块是业务终端模块）

---

## 6. 扩展性设计

### 6.1 支持多种消息类型

当前支持文本消息，未来可扩展：
- 图片消息
- 文件消息
- 语音消息

通过 `metadata` 字段存储额外信息。

---

### 6.2 流式输出（已实现）

Agent 执行时支持流式输出：
1. Agent 通过 StreamCallback 接口实时推送内容
2. WebSocketStreamCallback 将事件转换为 WebSocket 消息
3. 客户端实时接收并显示部分内容
4. 执行完成后保存完整消息到数据库

**支持的流式事件**：
- `onThinking()` - Agent 开始思考
- `onStream(chunk)` - 流式输出内容片段
- `onToolCall(toolName, toolArgs)` - 调用工具
- `onRequestInput(prompt)` - 请求用户输入
- `onComplete(fullContent)` - 执行完成
- `onError(error)` - 执行错误

**中断支持**：
- 用户可随时发送 INTERRUPT 消息
- Agent 通过 `isInterrupted()` 检查中断标志
- 检测到中断后立即停止执行

---

### 6.3 支持会话分享

未来可支持会话分享：
1. 生成分享链接
2. 设置分享权限
3. 查看分享的会话历史

---

## 7. 设计优势

### 7.1 清晰的职责划分
- 会话管理与消息管理分离
- WebSocket 通信独立处理
- Agent 执行委托给 Agent 模块

### 7.2 实时性
- WebSocket 实现实时消息推送
- 支持流式输出
- 心跳保活机制

### 7.3 可扩展性
- 支持多种消息类型
- 支持多种 Agent 类型
- 支持会话分享

### 7.4 可追溯性
- 完整记录对话历史
- 记录执行元数据
- 支持历史查询和分析

---
