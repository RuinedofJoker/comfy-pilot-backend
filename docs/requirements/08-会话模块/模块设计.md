# 会话模块 - 模块设计

> 本模块负责AI对话、消息管理、WebSocket通信、工作流同步

## 1. 模块概述

### 1.1 模块定位
会话模块是用户与 AI Agent 交互的核心模块，负责管理对话会话、消息历史、实时通信。

### 1.2 核心职责
- 会话生命周期管理（创建、查询、更新、删除）
- 消息发送/接收和历史记录
- WebSocket 实时通信
- 会话-Agent 关联管理
- 会话-工作流版本关联

### 1.3 设计原则
- **会话隔离**：每个会话独立管理消息历史
- **实时响应**：WebSocket 实现实时消息推送
- **历史可追溯**：完整记录对话历史
- **Agent 可切换**：支持会话中切换 Agent
- **工作流关联**：会话可关联工作流版本

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                             │
│              WebSocket + REST API                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  会话模块 (Session)                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │  1. 会话管理层                                   │   │
│  │     - ChatSessionService                         │   │
│  │     - 会话 CRUD                                  │   │
│  │     - 会话-Agent 关联                            │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  2. 消息管理层                                   │   │
│  │     - ChatMessageService                         │   │
│  │     - 消息发送/接收                              │   │
│  │     - 消息历史查询                               │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  3. WebSocket 通信层                             │   │
│  │     - ChatWebSocketHandler                       │   │
│  │     - 连接管理                                   │   │
│  │     - 实时消息推送                               │   │
│  └─────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  Agent 模块                               │
│              AgentExecutor → Agent                       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 会话-Agent 交互流程

```
用户
  ↓ 1. 发送消息（WebSocket/REST）
ChatSessionController/WebSocketHandler
  ↓ 2. 接收消息
ChatSessionService
  ↓ 3. 保存用户消息到 chat_message
  ↓ 4. 获取会话关联的 Agent ID
  ↓ 5. 调用 AgentExecutor.execute()
AgentExecutor
  ↓ 6. 执行 Agent
  ↓ 7. 返回 Agent 响应
ChatSessionService
  ↓ 8. 保存 Agent 消息到 chat_message
  ↓ 9. 推送消息给用户（WebSocket）
用户
```

---

## 3. 核心组件

### 3.1 ChatSession（会话实体）

**职责**：
- 表示一个对话会话
- 关联用户和 Agent
- 管理会话状态

**核心属性**：
- `sessionCode` - 会话唯一编码
- `userId` - 用户 ID
- `agentId` - 关联的 Agent ID
- `title` - 会话标题
- `status` - 会话状态（ACTIVE/ARCHIVED）

**领域行为**：
- `updateTitle()` - 更新会话标题
- `archive()` - 归档会话
- `activate()` - 激活会话
- `changeAgent()` - 切换 Agent

---

### 3.2 ChatMessage（消息实体）

**职责**：
- 表示一条对话消息
- 区分用户消息和 Agent 消息

**核心属性**：
- `sessionId` - 所属会话 ID
- `role` - 消息角色（USER/ASSISTANT）
- `content` - 消息内容
- `metadata` - 元数据（JSON 格式）

**元数据示例**：
```json
{
  "model": "gpt-4",
  "tokens": 150,
  "executionTimeMs": 1200
}
```

---

### 3.3 ChatSessionService（会话服务）

**职责**：
- 会话管理
- 消息发送/接收
- 调用 Agent 执行

**核心方法**：
- `createSession()` - 创建会话
- `getSession()` - 获取会话详情
- `listSessions()` - 查询会话列表
- `updateSession()` - 更新会话
- `deleteSession()` - 删除会话
- `sendMessage()` - 发送消息（调用 Agent）
- `getMessages()` - 获取消息历史

---

### 3.4 ChatWebSocketHandler（WebSocket 处理器）

**职责**：
- WebSocket 连接管理
- 实时消息推送
- 心跳保活

**核心方法**：
- `afterConnectionEstablished()` - 连接建立
- `handleTextMessage()` - 处理文本消息
- `afterConnectionClosed()` - 连接关闭
- `sendMessage()` - 推送消息给客户端

---

## 4. 业务逻辑

### 4.1 创建会话

**流程**：
1. 用户选择 Agent
2. 创建会话记录
3. 生成会话编码
4. 返回会话信息

**规则**：
- 会话编码唯一
- 必须关联有效的 Agent
- 初始状态为 ACTIVE

---

### 4.2 发送消息

**流程**：
1. 接收用户消息
2. 保存用户消息到数据库
3. 获取会话关联的 Agent
4. 调用 AgentExecutor 执行
5. 保存 Agent 响应到数据库
6. 推送响应给用户（WebSocket）

**规则**：
- 消息内容不能为空
- 会话必须处于 ACTIVE 状态
- Agent 必须存在且可用
- 记录执行时间和 Token 使用量

---

### 4.3 消息历史查询

**流程**：
1. 根据会话 ID 查询消息
2. 按时间正序排列
3. 支持分页

**规则**：
- 只能查询自己的会话消息
- 支持按角色过滤（USER/ASSISTANT）

---

### 4.4 WebSocket 通信

**连接建立**：
1. 客户端发起 WebSocket 连接
2. 携带 Token 进行认证
3. 建立连接并保存 Session

**消息推送**：
1. Agent 执行完成后
2. 通过 WebSocket 推送消息
3. 支持流式输出（可选）

**心跳保活**：
1. 客户端定期发送 PING
2. 服务端响应 PONG
3. 超时自动断开连接

---

## 5. 依赖关系

### 5.1 依赖的模块
- **Agent 模块**：调用 AgentExecutor 执行 Agent
- **User 模块**：获取用户信息
- **Workflow 模块**：关联工作流版本（可选）

### 5.2 被依赖的模块
- 无（会话模块是业务终端模块）

---

## 6. 扩展性设计

### 6.1 支持多种消息类型

当前支持文本消息，未来可扩展：
- 图片消息
- 文件消息
- 语音消息

通过 `metadata` 字段存储额外信息。

---

### 6.2 支持流式输出

Agent 执行时支持流式输出：
1. Agent 生成 Token 时实时推送
2. 通过 WebSocket 推送部分内容
3. 最终保存完整消息

---

### 6.3 支持会话分享

未来可支持会话分享：
1. 生成分享链接
2. 设置分享权限
3. 查看分享的会话历史

---

## 7. 设计优势

### 7.1 清晰的职责划分
- 会话管理与消息管理分离
- WebSocket 通信独立处理
- Agent 执行委托给 Agent 模块

### 7.2 实时性
- WebSocket 实现实时消息推送
- 支持流式输出
- 心跳保活机制

### 7.3 可扩展性
- 支持多种消息类型
- 支持多种 Agent 类型
- 支持会话分享

### 7.4 可追溯性
- 完整记录对话历史
- 记录执行元数据
- 支持历史查询和分析

---
