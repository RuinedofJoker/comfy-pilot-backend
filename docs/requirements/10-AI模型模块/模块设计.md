# AI模型模块 - 模块设计

> 本模块负责模型提供商、模型配置、接口调用

## 模块功能

### 核心功能
- 模型提供商管理（CRUD）
- 模型配置管理（CRUD）
- 支持两种接入方式：远程API接入和本地接入
- 支持多种模型类型：LLM、Embedding、情感分类等
- 支持两种模型来源：远程API创建和代码预定义
- 每种接入方式有独立的接入逻辑
- **模型能力抽象层**：提供统一的模型能力调用接口
- **能力路由与调度**：根据能力类型和约束条件智能选择模型
- **模型执行器**：封装不同提供商的实际调用逻辑
- **模型工厂**：提供 ChatModel 和 StreamingChatModel 的创建接口

---

## 业务逻辑

### 1. 模型接入方式

#### 1.1 远程API接入（REMOTE_API）

**适用场景**:
- OpenAI GPT系列
- Anthropic Claude系列
- 阿里云通义千问
- 其他云端API服务

**必需信息**:
- 模型提供商（ModelProvider）
- 模型配置（AiModel，包含 API 密钥）

**接入流程**:
1. 创建模型提供商（配置API Base URL）
2. 创建模型配置（关联提供商，设置access_type为remote_api，在model_config中配置API密钥）
3. 调用时使用提供商的API Base URL + 模型配置中的API密钥

#### 1.2 本地接入（LOCAL）

**适用场景**:
- Ollama本地模型
- 自定义本地推理引擎
- 私有化部署的模型服务

**必需信息**:
- 模型配置（AiModel）
- 本地模型路径或服务地址（存储在model_config中）

**接入流程**:
1. 创建模型配置（设置access_type为local，不关联提供商）
2. 在model_config中配置本地模型路径或服务地址
3. 通过代码方式实现本地调用逻辑

---

### 2. 模型类型（Model Type）

系统支持多种模型类型，采用可扩展的枚举设计：

| 模型类型 | 说明 | 应用场景 |
|---------|------|---------|
| LLM | 大语言模型 | 对话、文本生成、问答等 |
| EMBEDDING | 嵌入模型 | 文本向量化、语义搜索等 |
| SENTIMENT_CLASSIFICATION | 情感分类模型 | 情感分析、舆情监控等 |
| TOKEN_CLASSIFICATION | Token分类模型 | 命名实体识别、词性标注等 |
| IMAGE_GENERATION | 图像生成模型 | 图像生成、图像编辑等 |
| SPEECH_RECOGNITION | 语音识别模型 | 语音转文字等 |
| TEXT_TO_SPEECH | 文本转语音模型 | 文字转语音等 |

**说明**：
- 当前平台主要使用 LLM 和 EMBEDDING 模型
- 模型类型可扩展，支持未来添加新的模型类型

---

### 3. 模型来源（Model Source）

模型来源决定了管理员对模型的管理权限：

#### 3.1 远程API创建（REMOTE_API）

**特点**：
- 通过管理页面API创建的模型
- 管理员拥有完全管理权限

**管理权限**：
- ✅ 创建：可以通过API创建新模型
- ✅ 修改：可以修改所有字段（modelName、modelConfig、description等）
- ✅ 删除：可以删除模型

#### 3.2 代码预定义（CODE_DEFINED）

**特点**：
- 由代码初始化创建的模型
- 系统核心依赖的模型配置

**管理权限**：
- ❌ 创建：不能通过API创建，只能由代码创建
- ⚠️ 修改：只能修改基本信息（modelName、description），不能修改模型配置（modelConfig）
- ❌ 删除：不能删除，保证系统稳定性

---

### 4. 业务规则

#### 4.1 模型提供商管理

**创建规则**:
- provider_name 不能为空
- provider_type 必须是预定义的枚举值
- api_base_url 对于远程API提供商是必填的

**更新规则**:
- 可以更新提供商的基本信息
- 不能修改已被模型引用的提供商类型

**删除规则**:
- 不能删除已被模型引用的提供商

#### 4.2 模型配置管理

**创建规则**:
- model_identifier 必须唯一
- model_type 必须是预定义的枚举值（llm/embedding/sentiment_classification等）
- access_type 为 remote_api 时，provider_id 不能为空
- access_type 为 local 时，provider_id 必须为空
- model_config 必须是有效的JSON格式
- 通过API创建的模型，model_source 自动设置为 remote_api

**更新规则**:
- 不能修改 model_identifier
- 不能修改 access_type
- 不能修改 model_source
- model_source 为 remote_api 的模型：可以更新所有字段（modelName、modelConfig、description等）
- model_source 为 code_defined 的模型：只能更新基本信息（modelName、description），不能修改 modelConfig

**删除规则**:
- model_source 为 remote_api 的模型：可以删除
- model_source 为 code_defined 的模型：不能删除（系统会抛出业务异常）

---

### 5. 模型能力抽象层（Model Capability Layer）

#### 5.1 设计目标

**核心理念**：
- Agent 只负责决策，不直接接触模型
- Tool 是唯一接口，Agent 通过 Tool 调用能力
- 能力平级设计，LLM、Embedding、分类等是平级的能力
- 实现透明，模型来源、部署方式对 Agent 完全透明

**架构层次**：
```
Agent Layer (决策层)
    ↓ 只通过 Tool 调用
Tool Layer (能力抽象层)
    ↓ 调用统一接口
Model Capability Layer (模型能力层)
    ↓ 支持多种实现
Model Provider (模型提供者)
```

---

#### 5.2 模型能力类型（ModelCapability）

系统支持以下模型能力类型：

| 能力类型 | Code | 说明 | 应用场景 |
|---------|------|------|---------|
| TEXT_GENERATION | text_generation | 文本生成/对话 | LLM对话、文本生成、问答 |
| EMBEDDING | embedding | 向量生成 | 文本向量化、语义搜索 |
| CLASSIFICATION | classification | 文本分类 | 内容分类、意图识别 |
| SENTIMENT_ANALYSIS | sentiment_analysis | 情感分析 | 情感识别、舆情监控 |
| ENTITY_RECOGNITION | entity_recognition | 实体识别 | 命名实体识别、信息抽取 |
| RERANK | rerank | 重排序 | 搜索结果重排、相关性排序 |

**说明**：
- 所有能力类型是平级的，不存在主次关系
- 一个模型可以支持多种能力
- 能力类型可扩展，支持未来添加新能力

---

#### 5.3 模型配置结构（model_config）

模型的 `model_config` 字段存储 JSON 格式的配置，包含能力声明和参数配置：

**配置示例**：
```json
{
  "capabilities": ["TEXT_GENERATION", "CLASSIFICATION"],
  "parameters": {
    "max_tokens": 4096,
    "temperature": 0.7,
    "top_p": 1.0
  },
  "priority": 10,
  "cost_per_1k_tokens": 0.002
}
```

**字段说明**：
- `capabilities`: 模型支持的能力列表
- `parameters`: 模型默认参数配置
- `priority`: 优先级（数值越大优先级越高）
- `cost_per_1k_tokens`: 每1000个token的成本（美元）

---

### 6. 模型工厂（Model Factory）

#### 6.1 设计目标

**核心理念**：
- 提供统一的模型创建接口
- 封装不同提供商的模型实例化逻辑
- 支持 Agent 配置覆盖模型默认配置
- 自动处理模型查询和提供商查询

**工厂类型**：
- `ChatModelFactory`: 创建非流式对话模型
- `StreamingChatModelFactory`: 创建流式对话模型

---

#### 6.2 工厂接口设计

**接口签名**：
```java
// 非流式模型工厂
public interface ChatModelFactory {
    ChatModel createChatModel(String modelIdentifier, Map<String, Object> agentConfig);
}

// 流式模型工厂
public interface StreamingChatModelFactory {
    StreamingChatModel createStreamingChatModel(String modelIdentifier, Map<String, Object> agentConfig);
}
```

**参数说明**：
- `modelIdentifier`: 模型唯一标识符
- `agentConfig`: Agent 指定的模型配置，用于覆盖模型默认配置（可为null）

---

#### 6.3 配置覆盖机制

**配置优先级**：
1. Agent 配置（agentConfig）- 最高优先级
2. 模型默认配置（model_config）- 次优先级
3. 系统默认值 - 最低优先级

**支持覆盖的参数**：
- `temperature`: 温度参数（默认0.7）
- `maxTokens`: 最大token数
- `topP`: Top-P采样
- `timeout`: 超时时间（秒，默认60）

**配置示例**：
```java
// 模型默认配置（存储在 model_config 中）
{
  "apiKey": "sk-xxx",
  "temperature": 0.7,
  "maxTokens": 2000,
  "topP": 0.9,
  "timeout": 60
}

// Agent 配置覆盖
Map<String, Object> agentConfig = new HashMap<>();
agentConfig.put("temperature", 0.9);  // 覆盖温度参数
agentConfig.put("maxTokens", 4000);   // 覆盖最大token数

// 最终生效的配置
{
  "apiKey": "sk-xxx",        // 来自模型配置
  "temperature": 0.9,        // 来自 Agent 配置（覆盖）
  "maxTokens": 4000,         // 来自 Agent 配置（覆盖）
  "topP": 0.9,              // 来自模型配置
  "timeout": 60             // 来自模型配置
}
```

---

#### 6.4 API 密钥存储

**存储方式**：
- API 密钥以**明文形式**存储在 `model_config` JSON 字段中
- 不进行加密处理

**安全建议**：
- 确保数据库访问权限控制严格
- 建议在生产环境中使用数据库加密或其他安全措施
- 限制对 `model_config` 字段的直接访问

**配置格式**：
```json
{
  "apiKey": "sk-xxx",
  "temperature": 0.7,
  "maxTokens": 2000
}
```

---

**文档版本**: v1.1
**最后更新**: 2026-01-18
