# 数据模型设计

## 1. 用户表 (user)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| password | VARCHAR(255) | 密码(加密) | NOT NULL |
| display_name | VARCHAR(100) | 显示名称 | |
| email | VARCHAR(100) | 邮箱 | UNIQUE |
| avatar_url | VARCHAR(500) | 头像URL | |
| role | VARCHAR(20) | 角色 | NOT NULL, DEFAULT 'USER' |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |
| create_by | BIGINT | 创建人ID | NULL |
| update_time | TIMESTAMP | 更新时间 | NOT NULL |
| update_by | BIGINT | 更新人ID | NULL |
| is_deleted | BIGINT | 逻辑删除 | DEFAULT 0 |

**索引**:
- `idx_username` ON (username)
- `idx_email` ON (email)

**枚举值**:
- role: `ADMIN`, `USER`
- status: `ACTIVE`, `DISABLED`

## 2. ComfyUI 服务表 (comfyui_service)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| name | VARCHAR(100) | 服务名称 | NOT NULL |
| url | VARCHAR(500) | 服务URL | NOT NULL |
| description | TEXT | 描述 | |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'OFFLINE' |
| last_check_time | TIMESTAMP | 最后检测时间 | |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |
| create_by | BIGINT | 创建人ID | NULL |
| update_time | TIMESTAMP | 更新时间 | NOT NULL |
| update_by | BIGINT | 更新人ID | NULL |
| is_deleted | BIGINT | 逻辑删除 | DEFAULT 0 |

**索引**:
- `idx_status` ON (status)

**枚举值**:
- status: `ONLINE`, `OFFLINE`, `ERROR`

## 3. 工作流表 (workflow)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| service_id | BIGINT | 服务ID | FK, NOT NULL |
| name | VARCHAR(200) | 工作流名称 | NOT NULL |
| description | TEXT | 描述 | |
| workflow_data | JSON | 工作流JSON数据 | NOT NULL |
| is_favorite | TINYINT | 是否收藏 | DEFAULT 0 |
| last_used_at | TIMESTAMP | 最后使用时间 | |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |
| create_by | BIGINT | 创建人ID | NULL |
| update_time | TIMESTAMP | 更新时间 | NOT NULL |
| update_by | BIGINT | 更新人ID | NULL |
| is_deleted | BIGINT | 逻辑删除 | DEFAULT 0 |

**索引**:
- `idx_user_id` ON (user_id)
- `idx_service_id` ON (service_id)
- `idx_last_used_at` ON (last_used_at)

**外键**:
- `fk_workflow_user` FOREIGN KEY (user_id) REFERENCES user(id)
- `fk_workflow_service` FOREIGN KEY (service_id) REFERENCES comfyui_service(id)

## 4. 会话表 (chat_session)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| user_id | BIGINT | 用户ID | FK, NOT NULL |
| workflow_id | BIGINT | 工作流ID | FK, NOT NULL |
| title | VARCHAR(200) | 会话标题 | NOT NULL |
| status | VARCHAR(20) | 状态 | NOT NULL, DEFAULT 'ACTIVE' |
| last_message_summary | TEXT | 最后消息摘要 | |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |
| create_by | BIGINT | 创建人ID | NULL |
| update_time | TIMESTAMP | 更新时间 | NOT NULL |
| update_by | BIGINT | 更新人ID | NULL |
| is_deleted | BIGINT | 逻辑删除 | DEFAULT 0 |

**索引**:
- `idx_user_id` ON (user_id)
- `idx_workflow_id` ON (workflow_id)
- `idx_status` ON (status)

**外键**:
- `fk_session_user` FOREIGN KEY (user_id) REFERENCES user(id)
- `fk_session_workflow` FOREIGN KEY (workflow_id) REFERENCES workflow(id)

**枚举值**:
- status: `ACTIVE`, `COMPLETED`, `ARCHIVED`

## 5. 消息表 (chat_message)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| session_id | BIGINT | 会话ID | FK, NOT NULL |
| role | VARCHAR(20) | 角色 | NOT NULL |
| content | TEXT | 消息内容 | NOT NULL |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |

**索引**:
- `idx_session_id` ON (session_id)
- `idx_create_time` ON (create_time)

**外键**:
- `fk_message_session` FOREIGN KEY (session_id) REFERENCES chat_session(id)

**枚举值**:
- role: `USER`, `ASSISTANT`, `SYSTEM`

## 6. 工作流版本表 (workflow_version)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | PK, AUTO_INCREMENT |
| workflow_id | BIGINT | 工作流ID | FK, NOT NULL |
| session_id | BIGINT | 会话ID | FK, NULL |
| version_number | INT | 版本号 | NOT NULL |
| workflow_data | JSON | 工作流快照 | NOT NULL |
| change_summary | TEXT | 变更摘要 | |
| create_time | TIMESTAMP | 创建时间 | NOT NULL |
| create_by | BIGINT | 创建人ID | NULL |

**索引**:
- `idx_workflow_id` ON (workflow_id)
- `idx_session_id` ON (session_id)
- `idx_version_number` ON (workflow_id, version_number)

**外键**:
- `fk_version_workflow` FOREIGN KEY (workflow_id) REFERENCES workflow(id)
- `fk_version_session` FOREIGN KEY (session_id) REFERENCES chat_session(id)

## 7. 实体关系图

```
user (1) ----< (N) workflow
user (1) ----< (N) chat_session
comfyui_service (1) ----< (N) workflow
workflow (1) ----< (N) chat_session
workflow (1) ----< (N) workflow_version
chat_session (1) ----< (N) chat_message
chat_session (1) ----< (N) workflow_version
```

## 8. 数据字典说明

### 8.1 通用字段
- `create_time`: 记录创建时间，自动设置
- `create_by`: 创建人ID，关联用户表，暂时可为 NULL
- `update_time`: 记录更新时间，自动更新
- `update_by`: 更新人ID，关联用户表，暂时可为 NULL
- `is_deleted`: 逻辑删除标记，0=未删除，非0=删除时的时间戳

### 8.2 JSON 字段说明
- `workflow.workflow_data`: 存储 ComfyUI 工作流的完整 JSON 结构
- `workflow_version.workflow_data`: 存储工作流版本快照的完整 JSON 结构

### 8.3 业务规则
- 用户删除时，关联的工作流和会话不删除（保留数据）
- 服务删除时，需检查是否有关联的工作流
- 工作流删除时，关联的会话和版本保留（逻辑删除）
- 会话删除时，关联的消息物理删除（级联删除）
