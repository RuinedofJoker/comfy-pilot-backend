# Agent模块 - 模块设计

> 本模块负责Agent配置、调度、执行

## 1. 模块概述

### 1.1 模块定位
Agent 模块是 AI 能力的核心执行模块，负责管理 Agent 配置、调度 Agent 执行、集成 langchain4j 框架实现复杂的 AI 流程。

### 1.2 核心职责
- Agent 配置管理（查询、更新名称描述、状态管理）
- Agent 自动注册（应用启动时自动发现并注册代码定义的Agent）
- Agent 执行调度
- Agent 流程编排（基于 langchain4j）
- 执行日志记录
- 工具调用集成

### 1.3 设计原则
- **Agent 多样性**：支持多种 Agent 类型和流程
- **可扩展性**：易于添加新的 Agent 实现
- **流程编排**：基于 langchain4j 实现复杂流程
- **工具集成**：无缝调用 Tool 模块
- **执行追踪**：完整记录执行日志

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                  会话模块 (Session)                       │
│              ChatSessionService                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  Agent 模块 (Agent)                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │  1. Agent 配置管理层                             │   │
│  │     - AgentConfigService                         │   │
│  │     - Agent 配置查询、更新名称描述、状态管理     │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  2. Agent 执行层                                 │   │
│  │     - AgentExecutor                              │   │
│  │     - AgentRegistry                              │   │
│  │     - 执行日志记录                               │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  3. Agent 实现层（基于 langchain4j）             │   │
│  │     - SimpleAgent (简单对话)                     │   │
│  │     - WorkflowAgent (工作流编辑)                 │   │
│  │     - 支持子 Agent 调用                          │   │
│  └─────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│                  Tool 模块                                │
│              ToolExecutor → Tool → Model                 │
└─────────────────────────────────────────────────────────┘
```

### 2.2 Agent 执行流程

```
会话模块
  ↓ 1. 调用 AgentExecutor.execute()
AgentExecutor
  ↓ 2. 获取 Agent 配置
AgentConfigRepository
  ↓ 3. 从 AgentRegistry 获取 Agent 实例
AgentRegistry
  ↓ 4. 执行 Agent
Agent (SimpleAgent/WorkflowAgent)
  ↓ 5. 调用 ToolExecutor（如需要）
ToolExecutor
  ↓ 6. 调用 Tool
Tool → Model
  ↓ 7. 返回结果
Agent
  ↓ 8. 处理结果
  ↓ 9. 记录执行日志
AgentExecutionLogRepository
  ↓ 10. 返回响应
会话模块
```

---

## 3. 核心组件

### 3.1 AgentConfig（Agent 配置实体）

**职责**：
- 表示一个 Agent 配置
- 定义 Agent 类型和参数
- 管理 Agent 状态

**核心属性**：
- `agentCode` - Agent 唯一编码（代码定义，不可修改）
- `agentName` - Agent 名称（管理员可编辑）
- `agentType` - Agent 类型（代码定义，不可修改，如：SIMPLE/WORKFLOW）
- `description` - Agent 描述（管理员可编辑）
- `systemPrompt` - 系统提示词（代码定义，不可修改）
- `config` - Agent 配置（代码定义，不可修改，JSON 格式）
- `status` - Agent 状态（管理员可切换：ACTIVE/INACTIVE）

**领域行为**：
- `activate()` - 激活 Agent
- `deactivate()` - 停用 Agent
- `updateBasicInfo(name, description)` - 更新名称和描述

---

### 3.2 Agent 接口

**职责**：
- 定义 Agent 执行接口
- 所有 Agent 实现此接口
- 提供 Agent 元数据（用于自动注册）

**核心方法**：
```java
public interface Agent {
    /**
     * 获取 Agent 唯一编码（用于注册和查找）
     */
    String getAgentCode();

    /**
     * 获取 Agent 类型
     */
    AgentType getType();

    /**
     * 获取 Agent 默认名称（初始注册时使用）
     */
    String getDefaultName();

    /**
     * 获取 Agent 默认描述（初始注册时使用）
     */
    String getDefaultDescription();

    /**
     * 获取系统提示词
     */
    String getSystemPrompt();

    /**
     * 获取 Agent 配置（JSON格式）
     */
    String getConfig();

    /**
     * 执行 Agent
     */
    AgentExecutionResponse execute(AgentExecutionRequest request);
}
```

---

### 3.3 AgentExecutor（Agent 执行器）

**职责**：
- Agent 执行调度
- 执行日志记录
- 异常处理

**核心方法**：
- `execute(agentId, input)` - 执行指定 Agent
- `executeByCode(agentCode, input)` - 按编码执行 Agent

---

### 3.4 AgentRegistry（Agent 注册中心）

**职责**：
- Agent 实例管理
- Agent 自动注册（应用启动时自动发现所有Agent实现）
- Agent 查找
- 同步Agent配置到数据库

**核心方法**：
- `registerAgent(agent)` - 注册单个 Agent（内部方法）
- `syncAgentToDatabase(agent)` - 同步Agent配置到数据库（首次注册或更新元数据）
- `getAgentByCode(agentCode)` - 根据编码获取 Agent 实例
- `getAgentById(agentId)` - 根据ID获取 Agent 实例
- `getAllAgents()` - 获取所有 Agent 实例

**自动注册流程**：
1. 应用启动时，通过 `ApplicationContextAware` 获取所有 Agent Bean
2. 遍历所有 Agent 实例，调用 `registerAgent()` 注册到内存
3. 检查数据库中是否存在该 Agent 配置（根据 agentCode）
4. 如不存在，创建新配置记录（使用 Agent 提供的默认名称、描述等）
5. 如已存在，仅更新代码定义的字段（agentType、systemPrompt、config），保留管理员编辑的名称和描述

---

## 4. Agent 类型

### 4.1 SimpleAgent（简单对话 Agent）

**功能**：
- 简单的对话交互
- 调用 LLM 工具
- 支持系统提示词

**实现方式**：
- 基于 langchain4j 的 AiServices
- 使用 ChatLanguageModel
- 支持对话历史

**示例流程**：
```
用户输入
  ↓
SimpleAgent
  ↓
调用 LlmTool
  ↓
返回响应
```

---

### 4.2 WorkflowAgent（工作流编辑 Agent）

**功能**：
- 工作流编辑辅助
- 支持工具调用
- 支持子 Agent 调用

**实现方式**：
- 基于 langchain4j 的 AiServices
- 使用 @Tool 注解定义工具
- 支持复杂流程编排

**示例流程**：
```
用户输入
  ↓
WorkflowAgent
  ↓
分析意图
  ↓
调用工具（如需要）
  ↓
生成响应
```

---

## 5. 业务逻辑

### 5.1 Agent 自动注册（应用启动时）

**流程**：
1. 应用启动时，AgentRegistry 通过 Spring 容器获取所有 Agent Bean
2. 遍历每个 Agent，调用其元数据方法获取配置信息
3. 根据 agentCode 查询数据库中是否已存在配置
4. 如不存在：创建新的 AgentConfig 记录，使用 Agent 提供的默认值
5. 如已存在：仅更新代码定义的字段（agentType、systemPrompt、config），保留管理员编辑的 agentName 和 description
6. 将 Agent 实例注册到内存 Map 中，供后续执行使用

**规则**：
- Agent 编码（agentCode）必须唯一，由开发者在代码中定义
- 首次注册时，使用 Agent 提供的默认名称和描述
- 后续应用重启时，保留管理员在数据库中修改的名称和描述
- 代码定义的字段（agentType、systemPrompt、config）每次启动都会同步更新

---

### 5.2 更新 Agent 基本信息（管理员操作）

**流程**：
1. 管理员通过 API 提交新的名称和描述
2. 验证 Agent 是否存在
3. 仅更新 agentName 和 description 字段
4. 其他字段（agentType、systemPrompt、config）不允许修改
5. 返回更新后的配置信息

**规则**：
- 仅允许更新 agentName 和 description
- agentCode、agentType、systemPrompt、config 由代码定义，不可通过 API 修改
- 更新操作不影响 Agent 的执行逻辑

---

### 5.3 执行 Agent

**流程**：
1. 获取 Agent 配置
2. 验证 Agent 状态（必须为 ACTIVE）
3. 从 AgentRegistry 获取 Agent 实例
4. 执行 Agent
5. 记录执行日志
6. 返回执行结果

**规则**：
- Agent 必须存在且处于 ACTIVE 状态
- 记录执行时间和 Token 使用量
- 异常时记录错误信息

---

## 6. 依赖关系

### 6.1 依赖的模块
- **Tool 模块**：调用 ToolExecutor 执行工具
- **Model 模块**：通过 Tool 间接调用

### 6.2 被依赖的模块
- **Session 模块**：会话模块调用 AgentExecutor

---

## 7. 扩展性设计

### 7.1 添加新 Agent 类型

**开发步骤**：
1. 创建新的 Agent 实现类，实现 Agent 接口
2. 添加 @Component 注解，使其成为 Spring Bean
3. 实现所有接口方法：
   - `getAgentCode()` - 返回唯一的 Agent 编码（如："SIMPLE_CHAT_001"）
   - `getType()` - 返回 Agent 类型枚举
   - `getDefaultName()` - 返回默认名称（如："简单对话Agent"）
   - `getDefaultDescription()` - 返回默认描述
   - `getSystemPrompt()` - 返回系统提示词
   - `getConfig()` - 返回配置 JSON 字符串
   - `execute()` - 实现具体的执行逻辑
4. 重启应用，AgentRegistry 会自动发现并注册新 Agent
5. 管理员可通过 API 查看新 Agent，并根据需要修改名称和描述

**示例代码**：
```java
@Component
public class SimpleAgent implements Agent {

    @Override
    public String getAgentCode() {
        return "SIMPLE_CHAT_001";
    }

    @Override
    public AgentType getType() {
        return AgentType.SIMPLE;
    }

    @Override
    public String getDefaultName() {
        return "简单对话Agent";
    }

    @Override
    public String getDefaultDescription() {
        return "用于简单对话交互的Agent";
    }

    @Override
    public String getSystemPrompt() {
        return "你是一个友好的AI助手";
    }

    @Override
    public String getConfig() {
        return "{\"temperature\": 0.7, \"maxTokens\": 2000}";
    }

    @Override
    public AgentExecutionResponse execute(AgentExecutionRequest request) {
        // 实现具体的执行逻辑
    }
}
```

---

### 7.2 集成 langchain4j

**核心特性**：
- AiServices - AI 服务抽象
- ChatLanguageModel - 对话模型
- @Tool 注解 - 工具定义
- ChatMemory - 对话历史

**示例代码**：
```java
interface Assistant {
    @SystemMessage("你是一个工作流编辑助手")
    String chat(@UserMessage String message);
}

Assistant assistant = AiServices.builder(Assistant.class)
    .chatLanguageModel(chatModel)
    .chatMemory(chatMemory)
    .tools(toolExecutor)
    .build();
```

---

## 8. 设计优势

### 8.1 清晰的职责划分
- 配置管理与执行分离
- Agent 实现与调度分离
- 工具调用委托给 Tool 模块

### 8.2 可扩展性
- 易于添加新 Agent 类型
- 支持复杂流程编排
- 支持子 Agent 调用

### 8.3 可追溯性
- 完整记录执行日志
- 记录执行元数据
- 支持历史查询和分析

---
