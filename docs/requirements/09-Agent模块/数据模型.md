# Agent模块 - 数据模型

> 本文档定义Agent模块相关的数据表设计

## 1. 数据表概览

Agent 模块包含 2 个核心数据表：

1. **agent_config** - Agent配置表
2. **agent_execution_log** - Agent执行日志表

---

## 2. agent_config - Agent配置表

### 2.1 表说明

存储 Agent 的配置信息，包括 Agent 类型、系统提示词、配置参数等。

**重要说明**：
- Agent 通过代码创建，应用启动时自动注册到此表
- **代码定义字段**（不可通过API修改）：agent_code、agent_type、system_prompt、config
- **管理员可编辑字段**：agent_name、description、status

### 2.2 表结构

```sql
CREATE TABLE agent_config (
    id BIGSERIAL PRIMARY KEY,
    agent_code VARCHAR(50) UNIQUE NOT NULL,
    agent_name VARCHAR(100) NOT NULL,
    agent_type VARCHAR(50) NOT NULL,
    description TEXT,
    system_prompt TEXT,
    config JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by BIGINT,
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    is_deleted BOOLEAN DEFAULT FALSE
);

COMMENT ON TABLE agent_config IS 'Agent配置表';
COMMENT ON COLUMN agent_config.id IS 'Agent ID';
COMMENT ON COLUMN agent_config.agent_code IS 'Agent编码（唯一）';
COMMENT ON COLUMN agent_config.agent_name IS 'Agent名称';
COMMENT ON COLUMN agent_config.agent_type IS 'Agent类型：SIMPLE-简单对话，WORKFLOW-工作流编辑';
COMMENT ON COLUMN agent_config.description IS 'Agent描述';
COMMENT ON COLUMN agent_config.system_prompt IS '系统提示词';
COMMENT ON COLUMN agent_config.config IS 'Agent配置（JSON格式）';
COMMENT ON COLUMN agent_config.status IS 'Agent状态：ACTIVE-活跃，INACTIVE-停用';
COMMENT ON COLUMN agent_config.create_time IS '创建时间';
COMMENT ON COLUMN agent_config.create_by IS '创建人ID';
COMMENT ON COLUMN agent_config.update_time IS '更新时间';
COMMENT ON COLUMN agent_config.update_by IS '更新人ID';
COMMENT ON COLUMN agent_config.is_deleted IS '逻辑删除标记';
```

### 2.3 字段说明

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 | 可编辑性 |
|--------|------|------|------|--------|------|----------|
| id | BIGINT | - | 是 | 自增 | 主键 | 系统生成 |
| agent_code | VARCHAR | 50 | 是 | - | Agent唯一编码 | 代码定义 |
| agent_name | VARCHAR | 100 | 是 | - | Agent名称 | 管理员可编辑 |
| agent_type | VARCHAR | 50 | 是 | - | Agent类型 | 代码定义 |
| description | TEXT | - | 否 | - | Agent描述 | 管理员可编辑 |
| system_prompt | TEXT | - | 否 | - | 系统提示词 | 代码定义 |
| config | JSONB | - | 否 | - | Agent配置 | 代码定义 |
| status | VARCHAR | 20 | 是 | ACTIVE | Agent状态 | 管理员可切换 |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 | 系统生成 |
| create_by | BIGINT | - | 否 | - | 创建人ID | 系统生成 |
| update_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 | 系统生成 |
| update_by | BIGINT | - | 否 | - | 更新人ID | 系统生成 |
| is_deleted | BOOLEAN | - | 否 | FALSE | 逻辑删除标记 | 系统生成 |

### 2.4 索引设计

```sql
-- 主键索引
CREATE UNIQUE INDEX pk_agent_config ON agent_config(id);

-- 唯一索引
CREATE UNIQUE INDEX uk_agent_code ON agent_config(agent_code);

-- 普通索引
CREATE INDEX idx_agent_type ON agent_config(agent_type);
CREATE INDEX idx_status ON agent_config(status);
CREATE INDEX idx_create_time ON agent_config(create_time);

-- 复合索引
CREATE INDEX idx_type_status ON agent_config(agent_type, status);
```

### 2.5 枚举值

**agent_type（Agent类型）**：
- `SIMPLE` - 简单对话Agent
- `WORKFLOW` - 工作流编辑Agent

**status（Agent状态）**：
- `ACTIVE` - 活跃
- `INACTIVE` - 停用

### 2.6 config 字段说明

config 字段存储 Agent 的配置信息，采用 JSONB 格式。

**SimpleAgent 配置示例**：
```json
{
  "temperature": 0.7,
  "maxTokens": 2000,
  "modelId": 1
}
```

**WorkflowAgent 配置示例**：
```json
{
  "temperature": 0.7,
  "maxTokens": 2000,
  "modelId": 1,
  "tools": ["workflow_create", "workflow_update"],
  "enableSubAgent": true
}
```

---

## 3. agent_execution_log - Agent执行日志表

### 3.1 表说明

记录 Agent 的执行日志，包括输入、输出、执行状态、执行时间等。

### 3.2 表结构

```sql
CREATE TABLE agent_execution_log (
    id BIGSERIAL PRIMARY KEY,
    agent_id BIGINT NOT NULL,
    session_id BIGINT NOT NULL,
    input TEXT NOT NULL,
    output TEXT,
    status VARCHAR(20) NOT NULL,
    error_message TEXT,
    execution_time_ms BIGINT,
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by BIGINT,
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by BIGINT,
    is_deleted BOOLEAN DEFAULT FALSE
);

COMMENT ON TABLE agent_execution_log IS 'Agent执行日志表';
COMMENT ON COLUMN agent_execution_log.id IS '日志ID';
COMMENT ON COLUMN agent_execution_log.agent_id IS 'Agent ID';
COMMENT ON COLUMN agent_execution_log.session_id IS '会话ID';
COMMENT ON COLUMN agent_execution_log.input IS '输入内容';
COMMENT ON COLUMN agent_execution_log.output IS '输出内容';
COMMENT ON COLUMN agent_execution_log.status IS '执行状态：SUCCESS-成功，FAILED-失败';
COMMENT ON COLUMN agent_execution_log.error_message IS '错误信息';
COMMENT ON COLUMN agent_execution_log.execution_time_ms IS '执行时间（毫秒）';
COMMENT ON COLUMN agent_execution_log.create_time IS '创建时间';
COMMENT ON COLUMN agent_execution_log.create_by IS '创建人ID';
COMMENT ON COLUMN agent_execution_log.update_time IS '更新时间';
COMMENT ON COLUMN agent_execution_log.update_by IS '更新人ID';
COMMENT ON COLUMN agent_execution_log.is_deleted IS '逻辑删除标记';
```


### 3.3 字段说明

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | 自增 | 主键 |
| agent_id | BIGINT | - | 是 | - | Agent ID |
| session_id | BIGINT | - | 是 | - | 会话ID |
| input | TEXT | - | 是 | - | 输入内容 |
| output | TEXT | - | 否 | - | 输出内容 |
| status | VARCHAR | 20 | 是 | - | 执行状态 |
| error_message | TEXT | - | 否 | - | 错误信息 |
| execution_time_ms | BIGINT | - | 否 | - | 执行时间（毫秒） |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| create_by | BIGINT | - | 否 | - | 创建人ID |
| update_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| update_by | BIGINT | - | 否 | - | 更新人ID |
| is_deleted | BOOLEAN | - | 否 | FALSE | 逻辑删除标记 |

### 3.4 索引设计

```sql
-- 主键索引
CREATE UNIQUE INDEX pk_agent_execution_log ON agent_execution_log(id);

-- 普通索引
CREATE INDEX idx_agent_id ON agent_execution_log(agent_id);
CREATE INDEX idx_session_id ON agent_execution_log(session_id);
CREATE INDEX idx_status ON agent_execution_log(status);
CREATE INDEX idx_create_time ON agent_execution_log(create_time);

-- 复合索引
CREATE INDEX idx_agent_session ON agent_execution_log(agent_id, session_id);
CREATE INDEX idx_agent_status ON agent_execution_log(agent_id, status);
```

### 3.5 枚举值

**status（执行状态）**：
- `SUCCESS` - 执行成功
- `FAILED` - 执行失败

---

## 4. 表关系

### 4.1 ER 图

```
┌─────────────────┐
│  agent_config   │
│─────────────────│
│ id (PK)         │
│ agent_code      │
│ agent_name      │
│ agent_type      │
│ system_prompt   │
│ config          │
│ status          │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────┴────────────┐
│ agent_execution_log │
│─────────────────────│
│ id (PK)             │
│ agent_id (FK)       │
│ session_id (FK)     │
│ input               │
│ output              │
│ status              │
└─────────────────────┘
```

### 4.2 外键关系

```sql
-- agent_execution_log 外键
ALTER TABLE agent_execution_log
    ADD CONSTRAINT fk_log_agent
    FOREIGN KEY (agent_id)
    REFERENCES agent_config(id);

ALTER TABLE agent_execution_log
    ADD CONSTRAINT fk_log_session
    FOREIGN KEY (session_id)
    REFERENCES chat_session(id);
```

---

## 5. 数据示例

### 5.1 agent_config 示例数据

**重要说明**：以下数据由应用启动时自动注册生成，不需要手动插入。这里仅作为数据格式参考。

```sql
-- 以下数据由 AgentRegistry 在应用启动时自动生成
-- 开发者只需实现 Agent 接口并添加 @Component 注解即可

INSERT INTO agent_config (agent_code, agent_name, agent_type, description, system_prompt, config, status)
VALUES
    ('SIMPLE_AGENT_001', '简单对话Agent', 'SIMPLE', '用于简单对话交互的Agent',
     '你是一个友好的AI助手，请用简洁明了的语言回答用户的问题。',
     '{"temperature": 0.7, "maxTokens": 2000, "modelId": 1}', 'ACTIVE'),
    ('WORKFLOW_AGENT_001', '工作流编辑Agent', 'WORKFLOW', '用于辅助编辑ComfyUI工作流的Agent',
     '你是一个ComfyUI工作流编辑助手，帮助用户创建和编辑工作流。',
     '{"temperature": 0.7, "maxTokens": 2000, "modelId": 1, "tools": ["workflow_create"], "enableSubAgent": true}', 'ACTIVE');
```

### 5.2 agent_execution_log 示例数据

```sql
INSERT INTO agent_execution_log (agent_id, session_id, input, output, status, execution_time_ms)
VALUES
    (1, 1, '你好', '你好！我是AI助手，有什么可以帮助你的吗？', 'SUCCESS', 1200),
    (2, 1, '请帮我创建一个图像生成工作流', '好的，我来帮你创建一个图像生成工作流...', 'SUCCESS', 2500);
```

---

## 6. 查询示例

### 6.1 查询所有活跃的Agent

```sql
SELECT * FROM agent_config
WHERE status = 'ACTIVE'
  AND is_deleted = FALSE
ORDER BY create_time DESC;
```

### 6.2 查询Agent的执行日志

```sql
SELECT * FROM agent_execution_log
WHERE agent_id = 1
  AND is_deleted = FALSE
ORDER BY create_time DESC;
```

### 6.3 统计Agent的执行情况

```sql
SELECT
    agent_id,
    COUNT(*) as total_executions,
    SUM(CASE WHEN status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN status = 'FAILED' THEN 1 ELSE 0 END) as failed_count,
    AVG(execution_time_ms) as avg_execution_time
FROM agent_execution_log
WHERE is_deleted = FALSE
GROUP BY agent_id;
```

---
