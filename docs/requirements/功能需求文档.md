# ComfyPilot 功能需求文档

## 1. 项目概述

ComfyPilot 是一个基于 ComfyUI 的 AI 工作流管理平台，**核心功能是通过 Agent 对话实时创建和编辑工作流**。

### 技术栈

- **后端**: Spring Boot 3.x + MyBatis-Plus
- **数据库**: PostgreSQL (JSONB 支持)
- **架构**: DDD 四层架构 (interfaces/application/domain/infrastructure)

### 保留字段说明

为后续扩展，以下字段保留但暂不使用：
- `createdBy`/`updatedBy`: 创建人/更新人 ID（暂时为 null）
- `deleted`: 逻辑删除标记

## 2. 核心实体

### 2.1 Workflow（工作流）

**职责**: 存储 Agent 创建/编辑的 ComfyUI 工作流

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 主键（雪花算法） |
| name | String | 工作流名称 |
| description | String | 工作流描述 |
| workflowData | JSONB | ComfyUI 工作流 JSON |
| status | String | 状态：DRAFT/ACTIVE |
| createdAt/updatedAt | Timestamp | 时间戳（MyBatis-Plus 自动填充） |
| createdBy/updatedBy | Long | 保留字段（暂为 null） |
| deleted | SmallInt | 逻辑删除标记 |

**状态说明**:
- `DRAFT`: 草稿（Agent 编辑中）
- `ACTIVE`: 已激活（可执行）

### 2.2 AgentConversation（Agent 对话会话）

**职责**: 记录 Agent 与系统的对话上下文

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 主键 |
| workflowId | Long | 关联的工作流 ID |
| conversationData | JSONB | 对话历史 JSON |
| status | String | 会话状态：ACTIVE/COMPLETED |
| createdAt/updatedAt | Timestamp | 时间戳 |

### 2.3 AgentMessage（Agent 消息）

**职责**: 存储 Agent 对话中的每条消息

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 主键 |
| conversationId | Long | 关联的会话 ID |
| role | String | 角色：USER/ASSISTANT/SYSTEM |
| content | Text | 消息内容 |
| metadata | JSONB | 元数据（如操作类型） |
| createdAt | Timestamp | 创建时间 |

## 3. API 设计

### 3.1 Agent 对话 API（核心）

#### 创建对话会话
```
POST /api/v1/conversations
```
**请求**: `{ "workflowId": null }` （新建工作流时为 null）
**响应**: `{ "conversationId": "123", "status": "ACTIVE" }`

#### 发送消息（创建/编辑工作流）
```
POST /api/v1/conversations/{id}/messages
```
**请求**:
```json
{
  "role": "USER",
  "content": "创建一个文生图工作流，使用 SDXL 模型",
  "metadata": { "action": "CREATE_WORKFLOW" }
}
```
**响应**:
```json
{
  "messageId": "456",
  "assistantReply": "已创建工作流草稿，包含 SDXL 加载节点...",
  "workflowData": { /* ComfyUI JSON */ }
}
```

#### 获取对话历史
```
GET /api/v1/conversations/{id}/messages
```

### 3.2 工作流管理 API

#### 查询工作流列表
```
GET /api/v1/workflows?pageNum=1&pageSize=10&status=DRAFT
```

#### 获取工作流详情
```
GET /api/v1/workflows/{id}
```

#### 激活工作流
```
PUT /api/v1/workflows/{id}/activate
```

## 4. 数据库设计

### 4.1 workflow 表

```sql
CREATE TABLE workflow (
    id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    workflow_data JSONB NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    deleted SMALLINT NOT NULL DEFAULT 0,
    PRIMARY KEY (id)
);

CREATE INDEX idx_workflow_status ON workflow(status);
CREATE INDEX idx_workflow_deleted ON workflow(deleted);
```

### 4.2 agent_conversation 表

```sql
CREATE TABLE agent_conversation (
    id BIGINT NOT NULL,
    workflow_id BIGINT,
    conversation_data JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    PRIMARY KEY (id)
);

CREATE INDEX idx_conversation_workflow_id ON agent_conversation(workflow_id);
CREATE INDEX idx_conversation_status ON agent_conversation(status);
```

### 4.3 agent_message 表

```sql
CREATE TABLE agent_message (
    id BIGINT NOT NULL,
    conversation_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP,
    PRIMARY KEY (id)
);

CREATE INDEX idx_message_conversation_id ON agent_message(conversation_id);
CREATE INDEX idx_message_created_at ON agent_message(created_at);
```

## 5. 核心业务流程

### Agent 对话创建工作流

```
1. 用户发起对话 → 创建 AgentConversation
   ↓
2. 用户发送消息："创建一个文生图工作流"
   ↓
3. 系统调用 LLM 生成 ComfyUI JSON
   ↓
4. 创建 Workflow（状态：DRAFT）
   ↓
5. 保存 AgentMessage（USER + ASSISTANT）
   ↓
6. 返回工作流草稿给用户
   ↓
7. 用户继续对话编辑工作流
   ↓
8. 用户满意后激活工作流（DRAFT → ACTIVE）
```

### 状态说明

- **Workflow**: `DRAFT`（编辑中）→ `ACTIVE`（已激活）
- **Conversation**: `ACTIVE`（进行中）→ `COMPLETED`（已完成）

## 6. 技术实现要点

### 6.1 JSONB 字段处理

使用 MyBatis-Plus `JacksonTypeHandler` 处理 JSONB 字段：

```java
@TableField(typeHandler = JacksonTypeHandler.class)
private Map<String, Object> workflowData;
```

### 6.2 LLM 集成

- 调用 LLM API 生成/编辑 ComfyUI 工作流 JSON
- 解析用户自然语言指令
- 验证生成的工作流 JSON 格式

## 7. 实现优先级

### Phase 1: 核心对话功能（最高优先级）

- [ ] AgentConversation 实体类（PO/DTO/Entity）
- [ ] AgentMessage 实体类
- [ ] 对话会话 API（创建会话、发送消息、获取历史）
- [ ] LLM 集成服务（生成/编辑工作流 JSON）

### Phase 2: 工作流管理（高优先级）

- [ ] Workflow 实体类
- [ ] 工作流 CRUD API
- [ ] 工作流状态管理（DRAFT/ACTIVE）
- [ ] 数据库表创建 SQL

### Phase 3: 优化和扩展（中优先级）

- [ ] 对话上下文管理优化
- [ ] 工作流 JSON 验证
- [ ] 错误处理和重试机制

## 8. 待确认问题

### LLM 集成

- [ ] 使用哪个 LLM API（OpenAI/Claude/本地模型）
- [ ] ComfyUI 工作流 JSON 格式规范
- [ ] Prompt 工程策略（如何指导 LLM 生成正确的工作流）

### ComfyUI 集成

- [ ] ComfyUI 服务地址和访问方式
- [ ] 工作流 JSON 验证规则

---

**文档版本**: v2.0
**更新日期**: 2026-01-14
**核心变更**: 聚焦 Agent 对话创建/编辑工作流功能
