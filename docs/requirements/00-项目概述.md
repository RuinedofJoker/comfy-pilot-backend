# ComfyUI Pilot - 项目概述

## 项目定位
ComfyUI 的增强代理层，提供统一管理、AI 辅助编辑和版本管理能力。

## 核心价值
- 统一管理多个 ComfyUI 服务实例
- AI Agent 自然语言辅助编辑工作流
- 工作流版本管理和会话历史

## 系统架构
```
用户界面 (Web + AI Chat)
        ↓
代理系统 (认证/存储/AI/管理)
        ↓
ComfyUI 服务集群
```

## 用户角色
- **管理员**: 管理服务、用户、Agent、AI模型
- **普通用户**: 创建工作流、使用 AI 辅助、管理会话

## 技术栈
- **后端**: Spring Boot 3.x + PostgreSQL + Redis + MyBatis-Plus
- **前端**: Vue 3 + Element Plus
- **AI**: 多模型提供商集成 (OpenAI/Anthropic/国产模型)
- **通信**: WebSocket + RESTful API

## 核心模块

### 业务核心模块
1. **用户模块(user)**: 用户信息管理
2. **认证模块(auth)**: 登录认证、Token管理、密码重置
3. **权限模块(permission)**: 角色管理、权限控制、访问校验
4. **ComfyUI服务模块(cfsvr)**: ComfyUI 服务配置、连接测试、状态查询
5. **工作流模块(workflow)**: 工作流 CRUD、版本管理、快照机制、锁定控制
6. **会话模块(session)**: AI 对话、消息管理、WebSocket 通信、工作流同步
7. **Agent模块(agent)**: Agent 配置、调度、执行
8. **AI模型模块(model)**: 模型提供商、模型配置、接口调用
9. **资源模块(resource)**: 文件上传、存储管理

### 支撑服务模块
10. **通知模块(notification)**: 邮件发送、模板管理、异步队列
11. **监控模块(monitor)**: 服务健康检查、状态管理、统计数据
12. **审计日志模块(audit)**: 操作记录、安全审计、日志查询

## 模块包结构

### 包路径规范
所有模块位于：`org.joker.comfypilot.{module}`

### DDD四层架构
每个模块遵循DDD四层架构：
```
{module}/
├── interfaces/          # 接口层（用户接口层）
│   ├── controller/      # REST API 控制器
│   └── converter/       # DTO 转换器
├── application/         # 应用层
│   ├── service/         # 应用服务
│   └── dto/            # 数据传输对象
├── domain/             # 领域层
│   ├── entity/         # 领域实体
│   └── repository/     # 仓储接口
└── infrastructure/     # 基础设施层
    └── persistence/    # 持久化实现
        ├── mapper/     # MyBatis Mapper 接口
        └── po/         # 持久化对象
```

## 模块依赖关系
```
┌─────────────────────────────────────────────┐
│            接口层 (Controller)               │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│            应用层 (Service)                  │
│                                              │
│  [用户模块] ←→ [认证模块] ←→ [权限模块]      │
│       ↓            ↓            ↓            │
│  [ComfyUI服务模块] ←→ [工作流模块] ←→ [会话模块]    │
│       ↓            ↓            ↓            │
│  [Agent模块] ←→ [AI模型模块] ←→ [资源模块]   │
│                                              │
│  ────────────── 支撑层 ──────────────        │
│  [通知模块]  [监控模块]  [审计日志模块]      │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│         基础设施层 (Infrastructure)          │
│  [PostgreSQL]  [Redis]  [文件存储]          │
└─────────────────────────────────────────────┘
```

### 关键依赖说明
- **认证模块** → 通知模块（密码重置邮件）
- **权限模块** → 认证模块（获取用户角色）
- **ComfyUI服务模块** → 监控模块（获取服务状态）
- **工作流模块** → 会话模块（快照关联）
- **会话模块** → Agent模块（AI对话处理）
- **Agent模块** → AI模型模块（模型调用）
- **所有模块** → 审计日志模块（操作记录）

## 项目范围
**包含**: 用户基本信息、用户认证、服务管理、工作流 CRUD、AI 对话编辑、版本管理、Agent 管理、模型管理
**不包含**: ComfyUI 核心修改、自定义节点开发、实时协作

## 详细设计文档索引

### 文档说明
每个模块在独立子目录下包含三个文件：
- **模块设计.md**: 模块功能、依赖关系、业务逻辑
- **数据模型.md**: 数据表设计、字段定义、索引
- **API设计.md**: 接口定义、请求响应格式

### 业务核心模块
- [03-用户模块/](./03-用户模块/) - 用户信息管理
- [04-认证模块/](./04-认证模块/) - 登录认证、Token管理、密码重置
- [05-权限模块/](./05-权限模块/) - 角色管理、权限控制、访问校验
- [06-ComfyUI服务模块/](./06-ComfyUI服务模块/) - ComfyUI服务配置、连接测试、状态查询
- [07-工作流模块/](./07-工作流模块/) - 工作流CRUD、版本管理、快照机制、锁定控制
- [08-会话模块/](./08-会话模块/) - AI对话、消息管理、WebSocket通信、工作流同步
- [09-Agent模块/](./09-Agent模块/) - Agent配置、调度、执行
- [10-AI模型模块/](./10-AI模型模块/) - 模型提供商、模型配置、接口调用
- [11-资源模块/](./11-资源模块/) - 文件上传、存储管理

### 支撑服务模块
- [12-通知模块/](./12-通知模块/) - 邮件发送、模板管理、异步队列
- [13-监控模块/](./13-监控模块/) - 服务健康检查、状态管理、统计数据
- [14-审计日志模块/](./14-审计日志模块/) - 操作记录、安全审计、日志查询

### 技术规范
- [99-技术规范.md](./99-技术规范.md) - 架构规范、代码规范、数据库规范、API规范、安全规范
